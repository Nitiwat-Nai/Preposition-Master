<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preposition Master - ‡πÄ‡∏Å‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ö‡∏∏‡∏û‡∏ö‡∏ó</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Mobile-First CSS with New Color Theme (Purple/Pink/Green) --- */
        :root {
            --color-primary: #9C27B0; /* Deep Purple (‡∏õ‡∏∏‡πà‡∏° Next) */
            --color-secondary: #E1BEE7; /* Light Lavender (‡∏Ç‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) */
            --color-correct: #4CAF50; /* Primary Green (‡∏™‡∏µ‡∏ñ‡∏π‡∏Å) */
            --color-wrong: #FF5252; /* Bright Red (‡∏™‡∏µ‡∏ú‡∏¥‡∏î) */
            --color-bg: #F3E5F5; /* Very Light Purple/Pink (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á) */
            --color-card: #FFFFFF; /* White (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Header/‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) */
            --color-button-bg: #FCE4EC; /* Light Pink (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) */
            --color-text-dark: #333333;
            --color-text-light: #FFFFFF;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            background-color: var(--color-card);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
        }

        /* Header */
        header {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            padding: 1.5rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        header h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        /* Screen Management */
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: space-between;
        }
        .screen.active {
            display: flex;
        }

        /* --- Level Selection Screen --- */
        #level-select-screen .level-grid {
            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Grid 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level ‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 1rem 0;
        }
        .level-btn {
            background-color: #673AB7; 
            color: var(--color-text-light);
            border: none;
            padding: 1.2rem 0.5rem; /* ‡∏•‡∏î padding ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #5E35B1;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .level-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #5E35B1;
        }
        .level-btn-title {
            font-size: 0.9rem;
            font-weight: 400;
            display: block;
            margin-top: 5px;
            color: #D1C4E9;
        }
        .level-btn-type {
            font-size: 0.7rem;
            font-weight: 700;
            opacity: 0.8;
        }

        /* --- Game Screen --- */
        #game-screen {
            min-height: calc(100vh - 8rem);
            justify-content: flex-start;
        }
        #game-screen .top-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #game-screen .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #4A148C; 
        }

        /* Prompt Area (Question Sentence) */
        #prompt-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem; /* ‡∏•‡∏î margin */
            min-height: 100px;
            padding: 0 10px; 
        }
        #question-sentence {
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå */
            font-size: 1.6rem; 
            font-weight: bold;
            line-height: 1.5;
            text-align: left;
            padding: 15px; 
            background-color: #f7f7f7;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .blank {
            color: var(--color-primary);
            text-decoration: underline;
            padding: 0 5px;
        }
        
        /* Choices Area (4-button Grid) */
        #options-area {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            flex-grow: 1;
            padding-bottom: 1rem;
        }
        .option-btn {
            background-color: var(--color-button-bg);
            border: 3px solid var(--color-secondary); 
            border-radius: 12px; 
            padding: 10px 10px; /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
            
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em; 
            font-weight: bold;
            color: var(--color-text-dark);
        }

        .option-btn:hover, .option-btn:focus {
            border-color: var(--color-primary); 
        }
        
        /* Feedback Colors */
        .option-btn.correct {
            border-color: var(--color-correct) !important; 
            box-shadow: 0 0 15px #81C784; 
            background-color: #E8F5E9; 
            transform: scale(1.02);
        }
        .option-btn.incorrect {
            border-color: var(--color-wrong) !important; 
            animation: shake 0.5s;
            background-color: #FFEBEE; 
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }

        /* Footer/Control */
        #game-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ECEFF1;
            flex-shrink: 0; 
        }
        #next-btn {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #7B1FA2;
            transition: all 0.1s;
        }
        #next-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #7B1FA2;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>üó∫Ô∏è Preposition Master</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ö‡∏∏‡∏û‡∏ö‡∏ó</h2>
            <p>‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö (10 ‡∏Ç‡πâ‡∏≠/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡πà‡∏≠‡∏¢):</p>
            <div class="level-grid" id="level-grid">
                </div>
            <p style="padding-top: 1rem; color:#9E9E9E;">‡∏°‡∏µ 4 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏µ 3 ‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏£‡∏ß‡∏° 120 ‡∏Ç‡πâ‡∏≠</p>
        </div>

        <div id="game-screen" class="screen">
            <div class="top-content">
                <div class="status-bar">
                    <span id="level-title"></span>
                    <span id="q-count">‡∏Ç‡πâ‡∏≠: 0/10</span>
                    <span id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</span>
                </div>

                <div id="prompt-area">
                    <div id="question-sentence"></div>
                    <div id="feedback-message" style="margin-top:20px; font-weight:bold; color:var(--color-text-dark);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                </div>

                <div id="options-area">
                    </div>
            </div>

            <div id="game-footer">
                <button id="next-btn" disabled>‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>
    </div>

    <audio id="correct-audio" src="sounds/correct.mp3"></audio>
    <audio id="incorrect-audio" src="sounds/incorrect.mp3"></audio>

    <script>
        /* ------------------- JavaScript Core Logic (Preposition Master V4) ------------------- */

        // --- DATA (4 Main Types x 3 Sub-Levels = 12 Levels Total) ---
        const LEVEL_DATA = [
            // ========================================================================================
            // TYPE 1: PLACE (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
            { type: 1, title: "1. PLACE (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)", levels: [
                { sub: 1, name: "Basic (in, on, at)", questions: [ // L1.1
                    { sentence: "The book is ______ the table.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "The book is on the table." },
                    { sentence: "She lives ______ Bangkok.", correct: "in", distractors: ["on", "at", "over"], ttsContext: "She lives in Bangkok." },
                    { sentence: "I saw him standing ______ the corner.", correct: "at", distractors: ["in", "on", "from"], ttsContext: "I saw him standing at the corner." },
                    { sentence: "The picture is hanging ______ the wall.", correct: "on", distractors: ["in", "at", "with"], ttsContext: "The picture is hanging on the wall." },
                    { sentence: "The toys are ______ the box.", correct: "in", distractors: ["on", "at", "under"], ttsContext: "The toys are in the box." },
                    { sentence: "The cat is hiding ______ the sofa.", correct: "under", distractors: ["over", "at", "by"], ttsContext: "The cat is hiding under the sofa." },
                    { sentence: "I parked my car ______ the building.", correct: "behind", distractors: ["in", "on", "into"], ttsContext: "I parked my car behind the building." },
                    { sentence: "The plane flew ______ the mountains.", correct: "over", distractors: ["under", "at", "on"], ttsContext: "The plane flew over the mountains." },
                    { sentence: "Please meet me ______ the entrance.", correct: "at", distractors: ["in", "on", "with"], ttsContext: "Please meet me at the entrance." },
                    { sentence: "There is a beautiful garden ______ the house.", correct: "behind", distractors: ["on", "at", "with"], ttsContext: "There is a beautiful garden behind the house." },
                ]},
                { sub: 2, name: "Intermediate (between, next to)", questions: [ // L1.2
                    { sentence: "The store is located ______ the bank and the post office.", correct: "between", distractors: ["among", "near", "with"], ttsContext: "The store is located between the bank and the post office." },
                    { sentence: "The three friends sat ______ the campfire.", correct: "around", distractors: ["between", "next to", "on"], ttsContext: "The three friends sat around the campfire." },
                    { sentence: "My house is ______ the school.", correct: "near", distractors: ["on", "at", "above"], ttsContext: "My house is near the school." },
                    { sentence: "The pharmacy is ______ the coffee shop.", correct: "next to", distractors: ["in", "at", "over"], ttsContext: "The pharmacy is next to the coffee shop." },
                    { sentence: "He placed his hand ______ my shoulder.", correct: "on", distractors: ["in", "at", "under"], ttsContext: "He placed his hand on my shoulder." },
                    { sentence: "The children played happily ______ the trees.", correct: "among", distractors: ["between", "near", "on"], ttsContext: "The children played happily among the trees." },
                    { sentence: "The whiteboard is ______ the projector.", correct: "opposite", distractors: ["beside", "at", "over"], ttsContext: "The whiteboard is opposite the projector." },
                    { sentence: "I left my shoes ______ the door.", correct: "by", distractors: ["in", "on", "above"], ttsContext: "I left my shoes by the door." },
                    { sentence: "The clouds floated ______ the city.", correct: "above", distractors: ["under", "at", "on"], ttsContext: "The clouds floated above the city." },
                    { sentence: "The ship sailed ______ the coast.", correct: "along", distractors: ["in", "at", "under"], ttsContext: "The ship sailed along the coast." },
                ]},
                { sub: 3, name: "Advanced (in front of, over)", questions: [ // L1.3
                    { sentence: "They pitched their tent ______ the lake.", correct: "beside", distractors: ["in front of", "over", "at"], ttsContext: "They pitched their tent beside the lake." },
                    { sentence: "The car is parked ______ the building entrance.", correct: "in front of", distractors: ["behind", "on", "over"], ttsContext: "The car is parked in front of the building entrance." },
                    { sentence: "The temperature is ten degrees ______ zero.", correct: "below", distractors: ["above", "on", "at"], ttsContext: "The temperature is ten degrees below zero." },
                    { sentence: "The plane flew ______ the city.", correct: "over", distractors: ["through", "in", "at"], ttsContext: "The plane flew over the city." },
                    { sentence: "The restaurant is just ______ the corner.", correct: "around", distractors: ["in", "on", "at"], ttsContext: "The restaurant is just around the corner." },
                    { sentence: "I often find him hiding ______ the curtains.", correct: "behind", distractors: ["in front of", "on", "at"], ttsContext: "I often find him hiding behind the curtains." },
                    { sentence: "The sign was placed ______ the top of the hill.", correct: "at", distractors: ["on", "in", "over"], ttsContext: "The sign was placed at the top of the hill." },
                    { sentence: "The baby is lying ______ his mother.", correct: "beside", distractors: ["among", "over", "at"], ttsContext: "The baby is lying beside his mother." },
                    { sentence: "There's a fence running ______ the garden.", correct: "around", distractors: ["in", "at", "on"], ttsContext: "There's a fence running around the garden." },
                    { sentence: "We must look ______ the surface.", correct: "beneath", distractors: ["above", "on", "at"], ttsContext: "We must look beneath the surface." },
                ]},
            ]},
            // ========================================================================================
            // TYPE 2: TIME (‡πÄ‡∏ß‡∏•‡∏≤)
            { type: 2, title: "2. TIME (‡πÄ‡∏ß‡∏•‡∏≤)", levels: [
                { sub: 1, name: "Basic (at, on, in)", questions: [ // L2.1
                    { sentence: "The sun rises ______ the morning.", correct: "in", distractors: ["on", "at", "to"], ttsContext: "The sun rises in the morning." },
                    { sentence: "I always wake up ______ six o'clock.", correct: "at", distractors: ["in", "on", "for"], ttsContext: "I always wake up at six o'clock." },
                    { sentence: "We have a holiday ______ December.", correct: "in", distractors: ["on", "at", "with"], ttsContext: "We have a holiday in December." },
                    { sentence: "She was born ______ the 14th of June.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "She was born on the 14th of June." },
                    { sentence: "I will call you ______ the weekend.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "I will call you on the weekend." },
                    { sentence: "Dinner will be ready ______ half an hour.", correct: "in", distractors: ["on", "at", "before"], ttsContext: "Dinner will be ready in half an hour." },
                    { sentence: "The party is ______ Friday night.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The party is on Friday night." },
                    { sentence: "I feel tired ______ midnight.", correct: "at", distractors: ["in", "on", "until"], ttsContext: "I feel tired at midnight." },
                    { sentence: "He worked there ______ 2020.", correct: "in", distractors: ["on", "at", "since"], ttsContext: "He worked there in 2020." },
                    { sentence: "She always studies ______ night.", correct: "at", distractors: ["in", "on", "during"], ttsContext: "She always studies at night." },
                ]},
                { sub: 2, name: "Intermediate (since, for, during)", questions: [ // L2.2
                    { sentence: "We have been waiting ______ two hours.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We have been waiting for two hours." },
                    { sentence: "I haven't seen him ______ last summer.", correct: "since", distractors: ["for", "during", "at"], ttsContext: "I haven't seen him since last summer." },
                    { sentence: "She fell asleep ______ the movie.", correct: "during", distractors: ["for", "since", "on"], ttsContext: "She fell asleep during the movie." },
                    { sentence: "They traveled abroad ______ the summer break.", correct: "during", distractors: ["for", "since", "at"], ttsContext: "They traveled abroad during the summer break." },
                    { sentence: "He will finish the report ______ next week.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "He will finish the report by next week." },
                    { sentence: "I worked continuously ______ 5 AM.", correct: "until", distractors: ["by", "for", "in"], ttsContext: "I worked continuously until 5 A.M." },
                    { sentence: "It has been raining heavily ______ Monday morning.", correct: "since", distractors: ["for", "during", "on"], ttsContext: "It has been raining heavily since Monday morning." },
                    { sentence: "We stopped talking ______ a moment.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "We stopped talking for a moment." },
                    { sentence: "I finished my homework just ______ the deadline.", correct: "before", distractors: ["after", "during", "at"], ttsContext: "I finished my homework just before the deadline." },
                    { sentence: "We waited for the bus ______ 10 minutes.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We waited for the bus for 10 minutes." },
                ]}, 
                { sub: 3, name: "Advanced (by, until, in time, on time)", questions: [ // L2.3
                    { sentence: "You must submit the application ______ Friday.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "You must submit the application by Friday." },
                    { sentence: "The meeting is scheduled to start ______ 2:00 PM.", correct: "at", distractors: ["in", "on", "by"], ttsContext: "The meeting is scheduled to start at 2 P.M." },
                    { sentence: "We arrived ______ time for the flight.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We arrived in time for the flight." },
                    { sentence: "The train left exactly ______ time.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "The train left exactly on time." },
                    { sentence: "The contract is valid ______ the end of the year.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "The contract is valid until the end of the year." },
                    { sentence: "He promised to be here ______ five o'clock.", correct: "by", distractors: ["until", "since", "in"], ttsContext: "He promised to be here by five o'clock." },
                    { sentence: "The shop is closed ______ Sundays.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The shop is closed on Sundays." },
                    { sentence: "I haven't smoked a cigarette ______ five years.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "I haven't smoked a cigarette for five years." },
                    { sentence: "We managed to get to the airport just ______ time.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We managed to get to the airport just in time." },
                    { sentence: "I'll wait for you ______ the movie starts.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "I'll wait for you until the movie starts." },
                ]},
            ]},
            // ========================================================================================
            // TYPE 3: DIRECTION/MOVEMENT (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á/‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà)
            { type: 3, title: "3. DIRECTION (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á)", levels: [
                { sub: 1, name: "Basic (to, into, through)", questions: [ // L3.1
                    { sentence: "She walked ______ the park.", correct: "to", distractors: ["into", "through", "on"], ttsContext: "She walked to the park." },
                    { sentence: "He jumped ______ the pool.", correct: "into", distractors: ["to", "at", "on"], ttsContext: "He jumped into the pool." },
                    { sentence: "We drove ______ the tunnel.", correct: "through", distractors: ["into", "on", "at"], ttsContext: "We drove through the tunnel." },
                    { sentence: "The child ran ______ his mother.", correct: "toward", distractors: ["from", "on", "in"], ttsContext: "The child ran toward his mother." },
                    { sentence: "The hiker climbed ______ the mountain.", correct: "up", distractors: ["down", "across", "on"], ttsContext: "The hiker climbed up the mountain." },
                    { sentence: "I took the book ______ the shelf.", correct: "from", distractors: ["to", "out of", "on"], ttsContext: "I took the book from the shelf." },
                    { sentence: "The tourists walked ______ the street.", correct: "along", distractors: ["into", "at", "on"], ttsContext: "The tourists walked along the street." },
                    { sentence: "She stepped ______ the car.", correct: "out of", distractors: ["into", "on", "to"], ttsContext: "She stepped out of the car." },
                    { sentence: "The dog chased the cat ______ the house.", correct: "around", distractors: ["across", "through", "to"], ttsContext: "The dog chased the cat around the house." },
                    { sentence: "He moved ______ London when he was 10.", correct: "to", distractors: ["at", "in", "from"], ttsContext: "He moved to London when he was 10." },
                ]},
                { sub: 2, name: "Intermediate (across, along, past)", questions: [ // L3.2
                    { sentence: "The ferry takes people ______ the river.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "The ferry takes people across the river." },
                    { sentence: "We strolled quietly ______ the beach.", correct: "along", distractors: ["across", "past", "through"], ttsContext: "We strolled quietly along the beach." },
                    { sentence: "I saw her driving ______ my house yesterday.", correct: "past", distractors: ["across", "along", "into"], ttsContext: "I saw her driving past my house yesterday." },
                    { sentence: "He threw the ball ______ the fence.", correct: "over", distractors: ["under", "through", "along"], ttsContext: "He threw the ball over the fence." },
                    { sentence: "The train sped ______ the fields.", correct: "through", distractors: ["across", "along", "to"], ttsContext: "The train sped through the fields." },
                    { sentence: "The children ran ______ the playground.", correct: "around", distractors: ["across", "past", "to"], ttsContext: "The children ran around the playground." },
                    { sentence: "We have to walk ______ the bridge to get there.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "We have to walk across the bridge to get there." },
                    { sentence: "I followed the path ______ the hillside.", correct: "along", distractors: ["across", "past", "over"], ttsContext: "I followed the path along the hillside." },
                    { sentence: "The car drove straight ______ the intersection.", correct: "through", distractors: ["across", "past", "to"], ttsContext: "The car drove straight through the intersection." },
                    { sentence: "The runner went straight ______ the finish line.", correct: "for", distractors: ["to", "at", "on"], ttsContext: "The runner went straight for the finish line." },
                ]},
                { sub: 3, name: "Advanced (up, down, toward, away from)", questions: [ // L3.3
                    { sentence: "The price of oil went sharply ______ last month.", correct: "up", distractors: ["down", "toward", "away from"], ttsContext: "The price of oil went sharply up last month." },
                    { sentence: "Please move ______ the fire exit.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "Please move away from the fire exit." },
                    { sentence: "We walked slowly ______ the sound of the music.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "We walked slowly toward the sound of the music." },
                    { sentence: "Tears rolled ______ her face.", correct: "down", distractors: ["up", "toward", "from"], ttsContext: "Tears rolled down her face." },
                    { sentence: "The dog swam ______ the boat.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "The dog swam toward the boat." },
                    { sentence: "He looked ______ the ceiling with a confused expression.", correct: "up at", distractors: ["down at", "toward", "away from"], ttsContext: "He looked up at the ceiling with a confused expression." },
                    { sentence: "They are moving ______ the hustle and bustle of the city.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "They are moving away from the hustle and bustle of the city." },
                    { sentence: "The stream flows gently ______ the valley.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "The stream flows gently down the valley." },
                    { sentence: "The climber struggled ______ the steep slope.", correct: "up", distractors: ["down", "toward", "from"], ttsContext: "The climber struggled up the steep slope." },
                    { sentence: "He glanced ______ the list to check the names.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "He glanced down the list to check the names." },
                ]},
            ]},
            // ========================================================================================
            // TYPE 4: OTHER/COMPLEX (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)
            { type: 4, title: "4. OTHER (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)", levels: [
                { sub: 1, name: "Basic (of, with, for)", questions: [ // L4.1
                    { sentence: "This is a picture ______ my family.", correct: "of", distractors: ["for", "with", "at"], ttsContext: "This is a picture of my family." },
                    { sentence: "I wrote the letter ______ a pen.", correct: "with", distractors: ["by", "for", "to"], ttsContext: "I wrote the letter with a pen." },
                    { sentence: "The cake was made ______ my mother.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "The cake was made by my mother." },
                    { sentence: "She is famous ______ her kindness.", correct: "for", distractors: ["of", "with", "at"], ttsContext: "She is famous for her kindness." },
                    { sentence: "We talked ______ the new project.", correct: "about", distractors: ["to", "for", "with"], ttsContext: "We talked about the new project." },
                    { sentence: "I need to look ______ my keys.", correct: "for", distractors: ["up", "at", "with"], ttsContext: "I need to look for my keys." },
                    { sentence: "The room is full ______ people.", correct: "of", distractors: ["with", "for", "by"], ttsContext: "The room is full of people." },
                    { sentence: "The flight was delayed ______ bad weather.", correct: "due to", distractors: ["for", "with", "about"], ttsContext: "The flight was delayed due to bad weather." },
                    { sentence: "She traveled ______ plane.", correct: "by", distractors: ["with", "on", "in"], ttsContext: "She traveled by plane." },
                    { sentence: "I'm interested ______ learning French.", correct: "in", distractors: ["on", "at", "for"], ttsContext: "I'm interested in learning French." },
                ]},
                { sub: 2, name: "Intermediate (according to, instead of)", questions: [ // L4.2
                    { sentence: "______ the news, the flight has been cancelled.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "According to the news, the flight has been cancelled." },
                    { sentence: "He took a bus ______ a taxi to save money.", correct: "instead of", distractors: ["according to", "in spite of", "due to"], ttsContext: "He took a bus instead of a taxi to save money." },
                    { sentence: "Everyone agreed ______ John.", correct: "except for", distractors: ["instead of", "according to", "due to"], ttsContext: "Everyone agreed except for John." },
                    { sentence: "You must complete the task ______ yourself.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "You must complete the task by yourself." },
                    { sentence: "The committee is concerned ______ environmental issues.", correct: "about", distractors: ["for", "with", "of"], ttsContext: "The committee is concerned about environmental issues." },
                    { sentence: "He apologized ______ being late.", correct: "for", distractors: ["about", "with", "by"], ttsContext: "He apologized for being late." },
                    { sentence: "I'm going to the party ______ my best friend.", correct: "with", distractors: ["by", "for", "of"], ttsContext: "I'm going to the party with my best friend." },
                    { sentence: "The report contains information ______ the recent changes.", correct: "about", distractors: ["for", "with", "by"], ttsContext: "The report contains information about the recent changes." },
                    { sentence: "She decided to study medicine ______ becoming a lawyer.", correct: "instead of", distractors: ["according to", "due to", "in spite of"], ttsContext: "She decided to study medicine instead of becoming a lawyer." },
                    { sentence: "The meeting will proceed ______ the board's decision.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "The meeting will proceed according to the board's decision." },
                ]},
                { sub: 3, name: "Advanced (despite, in spite of, regarding)", questions: [ // L4.3
                    { sentence: "______ the heavy rain, they still went hiking.", correct: "in spite of", distractors: ["despite", "owing to", "regarding"], ttsContext: "In spite of the heavy rain, they still went hiking." },
                    { sentence: "______ his illness, he managed to attend the meeting.", correct: "despite", distractors: ["in spite of", "due to", "regarding"], ttsContext: "Despite his illness, he managed to attend the meeting." },
                    { sentence: "The failure was entirely ______ a lack of preparation.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The failure was entirely owing to a lack of preparation." },
                    { sentence: "We need more data ______ the sales figures.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "We need more data regarding the sales figures." },
                    { sentence: "The flight was delayed ______ mechanical problems.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The flight was delayed due to mechanical problems." },
                    { sentence: "The team won the game ______ a major setback.", correct: "despite", distractors: ["in spite of", "owing to", "according to"], ttsContext: "The team won the game despite a major setback." },
                    { sentence: "I lost my job, ______ which I had to move.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "I lost my job, owing to which I had to move." },
                    { sentence: "I have some questions ______ your last email.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "I have some questions regarding your last email." },
                    { sentence: "______ all the warnings, he continued to gamble.", correct: "in spite of", distractors: ["despite", "due to", "according to"], ttsContext: "In spite of all the warnings, he continued to gamble." },
                    { sentence: "The project was a success ______ the team's effort.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The project was a success due to the team's effort." },
                ]},
            ]},
        ];

        const QUESTIONS_PER_LEVEL = 10;
        const OPTIONS_COUNT = 4;

        // --- ELEMENTS ---
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelGridEl = document.getElementById('level-grid');

        const levelTitleEl = document.getElementById('level-title');
        const qCountEl = document.getElementById('q-count');
        const scoreEl = document.getElementById('score');
        const questionSentenceEl = document.getElementById('question-sentence');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const optionsArea = document.getElementById('options-area');
        const nextBtn = document.getElementById('next-btn');
        
        const correctAudio = document.getElementById('correct-audio');
        const incorrectAudio = document.getElementById('incorrect-audio');

        // TTS Setup
        const synth = window.speechSynthesis;
        let ttsUtterance = new SpeechSynthesisUtterance();
        ttsUtterance.lang = 'en-US'; 
        ttsUtterance.rate = 0.8; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô

        // --- GAME STATE ---
        let currentLevelData = null; // Stores the main type data
        let currentSubLevel = null; // Stores the sub-level data (questions array)
        let currentQuizIndex = 0; 
        let score = 0;
        let isAnswered = false;
        let currentQuestion = {};
        let currentLevelQuestions = []; 

        // --- TTS FUNCTION ---
        function setMaleVoice() {
            const voices = synth.getVoices();
            // Try to find a reliable male voice for US English, if available
            const maleVoice = voices.find(
                voice => voice.lang === 'en-US' && (voice.name.includes('Male') || voice.name.includes('Zira') || voice.name.includes('Google US English Male'))
            );
            
            if (maleVoice) {
                ttsUtterance.voice = maleVoice;
            } else {
                // Fallback to the default English voice
            }
        }

        /** * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        function speakAnswer(text, onEndCallback) {
            if (synth.speaking) {
                synth.cancel();
            }
            
            ttsUtterance.text = text;
            ttsUtterance.onend = null; 

            if (onEndCallback) {
                ttsUtterance.onend = onEndCallback;
            }
            
            // Check if voices are loaded before speaking
            if (synth.getVoices().length === 0) {
                 synth.onvoiceschanged = () => {
                    setMaleVoice();
                    synth.speak(ttsUtterance);
                };
            } else {
                synth.speak(ttsUtterance);
            }
        }
        

        // --- UI & SCREEN MANAGEMENT ---

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function createLevelButtons() {
            levelGridEl.innerHTML = '';
            
            LEVEL_DATA.forEach(typeData => {
                typeData.levels.forEach(level => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    
                    // Display Text: "L1.1 Basic"
                    btn.textContent = `L${typeData.type}.${level.sub} ${level.name.split('(')[0].trim()}`;
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'level-btn-title';
                    titleSpan.textContent = `(${level.name.split('(')[1] || ''}`; // e.g. "(in, on, at)"
                    
                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'level-btn-type';
                    typeSpan.textContent = typeData.title.split('. ')[1]; // e.g. "PLACE (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)"

                    btn.prepend(typeSpan);
                    btn.appendChild(titleSpan);

                    btn.setAttribute('data-type', typeData.type);
                    btn.setAttribute('data-sub', level.sub);

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                    if (level.questions.length < QUESTIONS_PER_LEVEL) {
                        // ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô V4 ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Level ‡πÉ‡∏´‡∏°‡πà
                        titleSpan.textContent = "(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)";
                    }
                    
                    btn.addEventListener('click', () => {
                        startLevel(typeData.type, level.sub);
                    });
                    levelGridEl.appendChild(btn);
                });
            });
        }

        function updateStatusBar() {
            if (currentSubLevel) {
                levelTitleEl.textContent = `${currentLevelData.title} | ${currentSubLevel.name.split('(')[0].trim()}`;
                qCountEl.textContent = `‡∏Ç‡πâ‡∏≠: ${currentQuizIndex + 1}/${currentLevelQuestions.length}`;
            }
            scoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
        }

        // --- GAME LOGIC ---

        function startLevel(typeId, subId) {
            currentLevelData = LEVEL_DATA.find(data => data.type === typeId);
            currentSubLevel = currentLevelData.levels.find(level => level.sub === subId);
            
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å Sub-Level ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏™‡∏∏‡πà‡∏°
            currentLevelQuestions = [...currentSubLevel.questions].sort(() => 0.5 - Math.random());
            currentQuizIndex = 0;
            score = 0; 
            showScreen('game-screen');
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuizIndex >= currentLevelQuestions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            nextBtn.textContent = '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
            nextBtn.disabled = true;
            feedbackMessageEl.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            feedbackMessageEl.style.color = 'var(--color-text-dark)';
            questionSentenceEl.innerHTML = ''; 

            optionsArea.innerHTML = ''; 
            
            updateStatusBar();
            setupQuestion();
        }

        /** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ö‡∏∏‡∏û‡∏ö‡∏ó 4 ‡∏ï‡∏±‡∏ß */
        function getPrepositionOptions(correctPreposition, distractors) {
            let options = [correctPreposition];
            
            options = [...options, ...distractors];

            // Common prepositions list for random fillers
            const commonPrepositions = ["in", "on", "at", "to", "for", "with", "by", "from", "of"];
            
            const uniqueOptions = new Set(options);

            for (const prep of commonPrepositions) {
                if (uniqueOptions.size < OPTIONS_COUNT && !uniqueOptions.has(prep)) {
                    uniqueOptions.add(prep);
                }
            }
            
            // Fallback: use other correct answers from the same sub-level as distractors
            if (uniqueOptions.size < OPTIONS_COUNT) {
                 for (const q of currentLevelQuestions) {
                    if (uniqueOptions.size >= OPTIONS_COUNT) break;
                    if (!uniqueOptions.has(q.correct)) {
                        uniqueOptions.add(q.correct);
                    }
                }
            }
            
            const finalOptions = Array.from(uniqueOptions);
            
            finalOptions.sort(() => Math.random() - 0.5); 
            
            return finalOptions.slice(0, OPTIONS_COUNT);
        }


        function setupQuestion() {
            currentQuestion = currentLevelQuestions[currentQuizIndex];
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            const formattedSentence = currentQuestion.sentence.replace('______', '<span class="blank">______</span>');
            questionSentenceEl.innerHTML = formattedSentence;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 4 ‡∏ï‡∏±‡∏ß
            const options = getPrepositionOptions(currentQuestion.correct, currentQuestion.distractors || []);
            
            options.forEach(prep => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.dataset.preposition = prep;
                button.dataset.isCorrect = prep === currentQuestion.correct;
                
                button.textContent = prep.toUpperCase(); 
                
                button.addEventListener('click', handleAnswer);
                optionsArea.appendChild(button);
            });
        }

        function handleAnswer(event) {
            if (isAnswered) return;
            isAnswered = true;
            
            const selectedButton = event.currentTarget;
            const selectedPreposition = selectedButton.dataset.preposition;
            const isCorrect = selectedButton.dataset.isCorrect === 'true';

            // 1. Disable all choices
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.removeEventListener('click', handleAnswer);
                btn.disabled = true;
            });

            // 2. Feedback
            let correctPrep = currentQuestion.correct;
            let ttsText = currentQuestion.ttsContext;

            if (isCorrect) {
                correctAudio.currentTime = 0;
                correctAudio.play();
                score++;
                selectedButton.classList.add('correct');
                
                // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace(
                    '______', 
                    `<span style="color:var(--color-correct); font-weight:900;">${selectedPreposition.toUpperCase()}</span>`
                );

                feedbackMessageEl.textContent = `‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! (${selectedPreposition.toUpperCase()})`;
                feedbackMessageEl.style.color = 'var(--color-correct)';

            } else {
                incorrectAudio.currentTime = 0;
                incorrectAudio.play();
                selectedButton.classList.add('incorrect');
                
                // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace(
                    '______', 
                    `<span style="color:var(--color-wrong); font-weight:900;">${selectedPreposition.toUpperCase()}</span>`
                );

                feedbackMessageEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${correctPrep.toUpperCase()}`;
                feedbackMessageEl.style.color = 'var(--color-wrong)';
                
                // Highlight the correct answer button
                const correctAnswerButton = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if (correctAnswerButton) {
                    correctAnswerButton.classList.add('correct');
                }
            }
            
            // 3. TTS (‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
            speakAnswer(ttsText, () => {
                // 4. Update status and enable next button
                updateStatusBar();
                
                // 5. ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Next
                setTimeout(() => {
                    nextBtn.disabled = false;
                }, 500); 
            });
        }


        function endGame() {
            // Cancel TTS if it was speaking
            if (synth.speaking) {
                synth.cancel();
            }

            levelTitleEl.textContent = `‡∏à‡∏ö Level ${currentLevelData.type}.${currentSubLevel.sub}!`;
            qCountEl.textContent = '';
            
            const totalQuestions = currentLevelQuestions.length;
            feedbackMessageEl.innerHTML = `
                <span style="font-size:2rem; font-weight:900; color:var(--color-primary);">
                    ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ ${score}/${totalQuestions} ‡∏Ç‡πâ‡∏≠
                </span>
                <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏•‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</p>
            `;
            feedbackMessageEl.style.color = 'var(--color-primary)';
            
            optionsArea.innerHTML = ''; 
            questionSentenceEl.innerHTML = '‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚ú®';

            nextBtn.textContent = '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å';
            nextBtn.disabled = false;
        }

        // --- EVENT LISTENERS ---
        
        // Next/Go Back button
        nextBtn.addEventListener('click', () => {
            // Cancel TTS if it was speaking when moving to next screen
            if (synth.speaking) {
                synth.cancel();
            }

            if (currentQuizIndex >= currentLevelQuestions.length) {
                // Back to Level Selection
                showScreen('level-select-screen');
                currentQuizIndex = 0; 
            } else {
                // Next Question
                currentQuizIndex++;
                nextQuestion();
            }
        });


        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up male voice preference when voices are loaded
            synth.onvoiceschanged = setMaleVoice; 
            setMaleVoice(); // Try to set it immediately

            createLevelButtons();
            showScreen('level-select-screen');
        });
    </script>
</body>
</html>
