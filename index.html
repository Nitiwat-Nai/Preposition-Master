<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Preposition Master V7</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Color Palette & Variables --- */
        :root {
            /* Main Theme Colors */
            --primary-color: #6C63FF; /* Vibrant Purple */
            --primary-dark: #5a52d5;
            --primary-light: #EEF2FF; /* Very light purple for backgrounds */
            
            --secondary-color: #FF6584; /* Pink Accent */
            
            --correct-color: #00B894; /* Mint Green */
            --wrong-color: #FF7675;   /* Soft Red */
            
            --bg-gradient: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            
            --text-dark: #2D3436;
            --text-grey: #636E72;
            --text-white: #FFFFFF;

            --radius-xl: 24px;
            --radius-md: 16px;
            --shadow-card: 0 10px 20px rgba(0,0,0,0.15);
            --shadow-btn: 0 4px 0 rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }

        /* --- Main Container --- */
        .container {
            width: 95%;
            max-width: 500px;
            height: 92vh;
            max-height: 900px;
            
            /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≤‡∏ß‡∏•‡∏á ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏á‡πÜ */
            background-color: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            
            border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Header --- */
        header {
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ç‡∏≤‡∏ß‡∏•‡πâ‡∏ß‡∏ô */
            background: var(--primary-light);
            padding: 1.5rem 1rem 1rem 1rem;
            border-bottom: 2px solid rgba(108, 99, 255, 0.1);
        }
        
        header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        /* Auto Mode Animation */
        @keyframes pulse-active {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); color: #FFD700; }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .auto-active {
            animation: pulse-active 2s infinite ease-in-out;
        }

        /* --- Screens --- */
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: space-between;
            overflow-y: auto; /* Allow scroll if content is long */
        }
        .screen.active { display: flex; }

        /* --- Level Grid (Colorful Cards) --- */
        .level-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default 1 column on very small screens */
            gap: 12px;
            padding: 10px 5px;
        }
        
        /* Responsive Grid: 2 columns on slightly wider screens */
        @media (min-width: 350px) {
            .level-grid { grid-template-columns: 1fr 1fr; }
        }

        .level-btn {
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏ß‡∏•‡πâ‡∏ß‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
            background: white; 
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°: ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
            display: flex;
            flex-direction: column;
            min-height: 80px; 
            height: auto;
            white-space: normal;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏™‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Level ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
        .level-btn[data-type="1"] { background: #E3F2FD; color: #1565C0; } /* Blueish */
        .level-btn[data-type="2"] { background: #E8F5E9; color: #2E7D32; } /* Greenish */
        .level-btn[data-type="3"] { background: #FFF3E0; color: #E65100; } /* Orangish */
        .level-btn[data-type="4"] { background: #F3E5F5; color: #6A1B9A; } /* Purplish */

        .level-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            filter: brightness(0.95); /* Darken slightly on hover */
        }

        .level-btn:disabled {
            background: #f5f5f5;
            color: #b0b0b0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .level-btn-type { font-size: 0.7rem; font-weight: 700; opacity: 0.7; margin-bottom: 5px; }
        .level-name-main { font-size: 1.1rem; font-weight: 800; line-height: 1.2; margin-bottom: 5px;}
        .level-sub-detail { font-size: 0.85rem; opacity: 0.9; line-height: 1.2; }

        /* --- Game Area --- */
        .top-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 50px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            font-weight: 700;
            color: var(--text-grey);
            font-size: 0.9rem;
        }
        .score-pill { color: var(--primary-color); }

        /* Question Box */
        #question-sentence {
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.6;
            text-align: left;
            padding: 25px;
            
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏ß‡∏•‡πâ‡∏ß‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏≠‡∏°‡∏ü‡πâ‡∏≤/‡∏°‡πà‡∏ß‡∏á‡∏à‡∏≤‡∏á‡πÜ */
            background: linear-gradient(to bottom right, #ffffff, #f8f9fe);
            border: 2px solid #edf2f7;
            
            border-radius: var(--radius-xl);
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            color: var(--text-dark);
            margin-bottom: 1rem;
            
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
            word-wrap: break-word;
        }

        /* --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö --- */
        .blank {
            color: var(--primary-color);
            font-weight: 800;
            padding: 0 5px;
            
            /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞ */
            text-decoration: none;
            
            /* ‡πÉ‡∏™‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
            border-bottom: 3px solid var(--primary-color);
            display: inline-block;
            line-height: 1.2;
        }

        #feedback-message {
            min-height: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 5px;
        }

        /* Options Grid */
        #options-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .option-btn {
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏ß ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô */
            background-color: var(--primary-light); 
            color: var(--primary-dark);
            
            border: none;
            border-radius: var(--radius-md);
            padding: 15px 10px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(108, 99, 255, 0.2); /* Colored shadow */
            transition: all 0.1s;
            
            /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß */
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            line-height: 1.2;
        }

        .option-btn:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(90, 82, 213, 0.4);
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* States */
        .option-btn.correct {
            background-color: var(--correct-color) !important;
            color: white !important;
            box-shadow: 0 4px 0 #008f72 !important;
        }
        
        .option-btn.incorrect {
            background-color: var(--wrong-color) !important;
            color: white !important;
            box-shadow: 0 4px 0 #d63031 !important;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Footer */
        #game-footer {
            margin-top: auto;
            padding-top: 1rem;
        }

        #next-btn {
            background-color: var(--text-dark);
            color: white;
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        
        #next-btn:active { transform: scale(0.98); }
        #next-btn:disabled { background-color: #dfe6e9; color: #b2bec3; cursor: default; box-shadow: none; }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 12px; height: 12px;
            z-index: 100;
            animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        /* Media Query for Mobile Text Sizing */
        @media (max-width: 400px) {
            #question-sentence { font-size: 1.3rem; padding: 15px; }
            .option-btn { font-size: 1.1rem; padding: 10px; }
            header h1 { font-size: 1.5rem; }
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="app-title">Preposition Master</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <div style="text-align: left; margin-bottom: 10px;">
                <h2 style="margin:0; color:var(--text-dark);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üéØ</h2>
                <p style="margin:5px 0 0 0; color:var(--text-grey);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</p>
            </div>
            <div class="level-grid" id="level-grid">
                </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="top-content">
                <div class="status-bar">
                    <span id="level-title">Level 1</span>
                    <span id="q-count">1/10</span>
                    <span class="score-pill" id="score">Score: 0</span>
                </div>

                <div id="prompt-area">
                    <div id="question-sentence"></div>
                    <div id="feedback-message">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                </div>

                <div id="options-area">
                    </div>
            </div>

            <div id="game-footer">
                <button id="next-btn" disabled>‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <audio id="correct-audio" src="sounds/correct.mp3"></audio>
    <audio id="incorrect-audio" src="sounds/incorrect.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>

    <script>
        /* ------------------- Preposition Master V7 Logic ------------------- */
        
        // Data Structure
        const LEVEL_DATA = [
            // TYPE 1: PLACE
            { type: 1, title: "1. PLACE (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)", levels: [
                { sub: 1, name: "Basic", detail: "(in, on, at)", questions: [ 
                    { sentence: "The book is ______ the table.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "The book is on the table." },
                    { sentence: "She lives ______ Bangkok.", correct: "in", distractors: ["on", "at", "over"], ttsContext: "She lives in Bangkok." },
                    { sentence: "I saw him standing ______ the corner.", correct: "at", distractors: ["in", "on", "from"], ttsContext: "I saw him standing at the corner." },
                    { sentence: "The picture is hanging ______ the wall.", correct: "on", distractors: ["in", "at", "with"], ttsContext: "The picture is hanging on the wall." },
                    { sentence: "The toys are ______ the box.", correct: "in", distractors: ["on", "at", "under"], ttsContext: "The toys are in the box." },
                    { sentence: "The cat is hiding ______ the sofa.", correct: "under", distractors: ["over", "at", "by"], ttsContext: "The cat is hiding under the sofa." },
                    { sentence: "I parked my car ______ the building.", correct: "behind", distractors: ["in", "on", "into"], ttsContext: "I parked my car behind the building." },
                    { sentence: "The plane flew ______ the mountains.", correct: "over", distractors: ["under", "at", "on"], ttsContext: "The plane flew over the mountains." },
                    { sentence: "Please meet me ______ the entrance.", correct: "at", distractors: ["in", "on", "with"], ttsContext: "Please meet me at the entrance." },
                    { sentence: "There is a beautiful garden ______ the house.", correct: "behind", distractors: ["on", "at", "with"], ttsContext: "There is a beautiful garden behind the house." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(between, next to)", questions: [ 
                    { sentence: "The store is located ______ the bank and the post office.", correct: "between", distractors: ["among", "near", "with"], ttsContext: "The store is located between the bank and the post office." },
                    { sentence: "The three friends sat ______ the campfire.", correct: "around", distractors: ["between", "next to", "on"], ttsContext: "The three friends sat around the campfire." },
                    { sentence: "My house is ______ the school.", correct: "near", distractors: ["on", "at", "above"], ttsContext: "My house is near the school." },
                    { sentence: "The pharmacy is ______ the coffee shop.", correct: "next to", distractors: ["in", "at", "over"], ttsContext: "The pharmacy is next to the coffee shop." },
                    { sentence: "He placed his hand ______ my shoulder.", correct: "on", distractors: ["in", "at", "under"], ttsContext: "He placed his hand on my shoulder." },
                    { sentence: "The children played happily ______ the trees.", correct: "among", distractors: ["between", "near", "on"], ttsContext: "The children played happily among the trees." },
                    { sentence: "The whiteboard is ______ the projector.", correct: "opposite", distractors: ["beside", "at", "over"], ttsContext: "The whiteboard is opposite the projector." },
                    { sentence: "I left my shoes ______ the door.", correct: "by", distractors: ["in", "on", "above"], ttsContext: "I left my shoes by the door." },
                    { sentence: "The clouds floated ______ the city.", correct: "above", distractors: ["under", "at", "on"], ttsContext: "The clouds floated above the city." },
                    { sentence: "The ship sailed ______ the coast.", correct: "along", distractors: ["in", "at", "under"], ttsContext: "The ship sailed along the coast." },
                ]},
                { sub: 3, name: "Advanced", detail: "(in front of, over)", questions: [
                    { sentence: "They pitched their tent ______ the lake.", correct: "beside", distractors: ["in front of", "over", "at"], ttsContext: "They pitched their tent beside the lake." },
                    { sentence: "The car is parked ______ the building entrance.", correct: "in front of", distractors: ["behind", "on", "over"], ttsContext: "The car is parked in front of the building entrance." },
                    { sentence: "The temperature is ten degrees ______ zero.", correct: "below", distractors: ["above", "on", "at"], ttsContext: "The temperature is ten degrees below zero." },
                    { sentence: "The plane flew ______ the city.", correct: "over", distractors: ["through", "in", "at"], ttsContext: "The plane flew over the city." },
                    { sentence: "The restaurant is just ______ the corner.", correct: "around", distractors: ["in", "on", "at"], ttsContext: "The restaurant is just around the corner." },
                    { sentence: "I often find him hiding ______ the curtains.", correct: "behind", distractors: ["in front of", "on", "at"], ttsContext: "I often find him hiding behind the curtains." },
                    { sentence: "The sign was placed ______ the top of the hill.", correct: "at", distractors: ["on", "in", "over"], ttsContext: "The sign was placed at the top of the hill." },
                    { sentence: "The baby is lying ______ his mother.", correct: "beside", distractors: ["among", "over", "at"], ttsContext: "The baby is lying beside his mother." },
                    { sentence: "There's a fence running ______ the garden.", correct: "around", distractors: ["in", "at", "on"], ttsContext: "There's a fence running around the garden." },
                    { sentence: "We must look ______ the surface.", correct: "beneath", distractors: ["above", "on", "at"], ttsContext: "We must look beneath the surface." },
                ]},
            ]},
            // TYPE 2: TIME
            { type: 2, title: "2. TIME (‡πÄ‡∏ß‡∏•‡∏≤)", levels: [
                { sub: 1, name: "Basic", detail: "(at, on, in)", questions: [
                    { sentence: "The sun rises ______ the morning.", correct: "in", distractors: ["on", "at", "to"], ttsContext: "The sun rises in the morning." },
                    { sentence: "I always wake up ______ six o'clock.", correct: "at", distractors: ["in", "on", "for"], ttsContext: "I always wake up at six o'clock." },
                    { sentence: "We have a holiday ______ December.", correct: "in", distractors: ["on", "at", "with"], ttsContext: "We have a holiday in December." },
                    { sentence: "She was born ______ the 14th of June.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "She was born on the 14th of June." },
                    { sentence: "I will call you ______ the weekend.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "I will call you on the weekend." },
                    { sentence: "Dinner will be ready ______ half an hour.", correct: "in", distractors: ["on", "at", "before"], ttsContext: "Dinner will be ready in half an hour." },
                    { sentence: "The party is ______ Friday night.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The party is on Friday night." },
                    { sentence: "I feel tired ______ midnight.", correct: "at", distractors: ["in", "on", "until"], ttsContext: "I feel tired at midnight." },
                    { sentence: "He worked there ______ 2020.", correct: "in", distractors: ["on", "at", "since"], ttsContext: "He worked there in 2020." },
                    { sentence: "She always studies ______ night.", correct: "at", distractors: ["in", "on", "during"], ttsContext: "She always studies at night." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(since, for, during)", questions: [
                    { sentence: "We have been waiting ______ two hours.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We have been waiting for two hours." },
                    { sentence: "I haven't seen him ______ last summer.", correct: "since", distractors: ["for", "during", "at"], ttsContext: "I haven't seen him since last summer." },
                    { sentence: "She fell asleep ______ the movie.", correct: "during", distractors: ["for", "since", "on"], ttsContext: "She fell asleep during the movie." },
                    { sentence: "They traveled abroad ______ the summer break.", correct: "during", distractors: ["for", "since", "at"], ttsContext: "They traveled abroad during the summer break." },
                    { sentence: "He will finish the report ______ next week.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "He will finish the report by next week." },
                    { sentence: "I worked continuously ______ 5 AM.", correct: "until", distractors: ["by", "for", "in"], ttsContext: "I worked continuously until 5 A.M." },
                    { sentence: "It has been raining heavily ______ Monday morning.", correct: "since", distractors: ["for", "during", "on"], ttsContext: "It has been raining heavily since Monday morning." },
                    { sentence: "We stopped talking ______ a moment.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "We stopped talking for a moment." },
                    { sentence: "I finished my homework just ______ the deadline.", correct: "before", distractors: ["after", "during", "at"], ttsContext: "I finished my homework just before the deadline." },
                    { sentence: "We waited for the bus ______ 10 minutes.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We waited for the bus for 10 minutes." },
                ]},
                { sub: 3, name: "Advanced", detail: "(by, until, in time)", questions: [
                    { sentence: "You must submit the application ______ Friday.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "You must submit the application by Friday." },
                    { sentence: "The meeting is scheduled to start ______ 2:00 PM.", correct: "at", distractors: ["in", "on", "by"], ttsContext: "The meeting is scheduled to start at 2 P.M." },
                    { sentence: "We arrived ______ time for the flight.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We arrived in time for the flight." },
                    { sentence: "The train left exactly ______ time.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "The train left exactly on time." },
                    { sentence: "The contract is valid ______ the end of the year.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "The contract is valid until the end of the year." },
                    { sentence: "He promised to be here ______ five o'clock.", correct: "by", distractors: ["until", "since", "in"], ttsContext: "He promised to be here by five o'clock." },
                    { sentence: "The shop is closed ______ Sundays.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The shop is closed on Sundays." },
                    { sentence: "I haven't smoked a cigarette ______ five years.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "I haven't smoked a cigarette for five years." },
                    { sentence: "We managed to get to the airport just ______ time.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We managed to get to the airport just in time." },
                    { sentence: "I'll wait for you ______ the movie starts.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "I'll wait for you until the movie starts." },
                ]},
            ]},
            // TYPE 3: DIRECTION
            { type: 3, title: "3. DIRECTION (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á)", levels: [
                { sub: 1, name: "Basic", detail: "(to, into, through)", questions: [
                    { sentence: "She walked ______ the park.", correct: "to", distractors: ["into", "through", "on"], ttsContext: "She walked to the park." },
                    { sentence: "He jumped ______ the pool.", correct: "into", distractors: ["to", "at", "on"], ttsContext: "He jumped into the pool." },
                    { sentence: "We drove ______ the tunnel.", correct: "through", distractors: ["into", "on", "at"], ttsContext: "We drove through the tunnel." },
                    { sentence: "The child ran ______ his mother.", correct: "toward", distractors: ["from", "on", "in"], ttsContext: "The child ran toward his mother." },
                    { sentence: "The hiker climbed ______ the mountain.", correct: "up", distractors: ["down", "across", "on"], ttsContext: "The hiker climbed up the mountain." },
                    { sentence: "I took the book ______ the shelf.", correct: "from", distractors: ["to", "out of", "on"], ttsContext: "I took the book from the shelf." },
                    { sentence: "The tourists walked ______ the street.", correct: "along", distractors: ["into", "at", "on"], ttsContext: "The tourists walked along the street." },
                    { sentence: "She stepped ______ the car.", correct: "out of", distractors: ["into", "on", "to"], ttsContext: "She stepped out of the car." },
                    { sentence: "The dog chased the cat ______ the house.", correct: "around", distractors: ["across", "through", "to"], ttsContext: "The dog chased the cat around the house." },
                    { sentence: "He moved ______ London when he was 10.", correct: "to", distractors: ["at", "in", "from"], ttsContext: "He moved to London when he was 10." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(across, along, past)", questions: [
                    { sentence: "The ferry takes people ______ the river.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "The ferry takes people across the river." },
                    { sentence: "We strolled quietly ______ the beach.", correct: "along", distractors: ["across", "past", "through"], ttsContext: "We strolled quietly along the beach." },
                    { sentence: "I saw her driving ______ my house yesterday.", correct: "past", distractors: ["across", "along", "into"], ttsContext: "I saw her driving past my house yesterday." },
                    { sentence: "He threw the ball ______ the fence.", correct: "over", distractors: ["under", "through", "along"], ttsContext: "He threw the ball over the fence." },
                    { sentence: "The train sped ______ the fields.", correct: "through", distractors: ["across", "along", "to"], ttsContext: "The train sped through the fields." },
                    { sentence: "The children ran ______ the playground.", correct: "around", distractors: ["across", "past", "to"], ttsContext: "The children ran around the playground." },
                    { sentence: "We have to walk ______ the bridge to get there.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "We have to walk across the bridge to get there." },
                    { sentence: "I followed the path ______ the hillside.", correct: "along", distractors: ["across", "past", "over"], ttsContext: "I followed the path along the hillside." },
                    { sentence: "The car drove straight ______ the intersection.", correct: "through", distractors: ["across", "past", "to"], ttsContext: "The car drove straight through the intersection." },
                    { sentence: "The runner went straight ______ the finish line.", correct: "for", distractors: ["to", "at", "on"], ttsContext: "The runner went straight for the finish line." },
                ]},
                { sub: 3, name: "Advanced", detail: "(up, down, toward)", questions: [
                    { sentence: "The price of oil went sharply ______ last month.", correct: "up", distractors: ["down", "toward", "away from"], ttsContext: "The price of oil went sharply up last month." },
                    { sentence: "Please move ______ the fire exit.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "Please move away from the fire exit." },
                    { sentence: "We walked slowly ______ the sound of the music.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "We walked slowly toward the sound of the music." },
                    { sentence: "Tears rolled ______ her face.", correct: "down", distractors: ["up", "toward", "from"], ttsContext: "Tears rolled down her face." },
                    { sentence: "The dog swam ______ the boat.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "The dog swam toward the boat." },
                    { sentence: "He looked ______ the ceiling with a confused expression.", correct: "up at", distractors: ["down at", "toward", "away from"], ttsContext: "He looked up at the ceiling with a confused expression." },
                    { sentence: "They are moving ______ the hustle and bustle of the city.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "They are moving away from the hustle and bustle of the city." },
                    { sentence: "The stream flows gently ______ the valley.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "The stream flows gently down the valley." },
                    { sentence: "The climber struggled ______ the steep slope.", correct: "up", distractors: ["down", "toward", "from"], ttsContext: "The climber struggled up the steep slope." },
                    { sentence: "He glanced ______ the list to check the names.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "He glanced down the list to check the names." },
                ]},
            ]},
            // TYPE 4: OTHER
            { type: 4, title: "4. OTHER (‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)", levels: [
                { sub: 1, name: "Basic", detail: "(of, with, for)", questions: [
                    { sentence: "This is a picture ______ my family.", correct: "of", distractors: ["for", "with", "at"], ttsContext: "This is a picture of my family." },
                    { sentence: "I wrote the letter ______ a pen.", correct: "with", distractors: ["by", "for", "to"], ttsContext: "I wrote the letter with a pen." },
                    { sentence: "The cake was made ______ my mother.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "The cake was made by my mother." },
                    { sentence: "She is famous ______ her kindness.", correct: "for", distractors: ["of", "with", "at"], ttsContext: "She is famous for her kindness." },
                    { sentence: "We talked ______ the new project.", correct: "about", distractors: ["to", "for", "with"], ttsContext: "We talked about the new project." },
                    { sentence: "I need to look ______ my keys.", correct: "for", distractors: ["up", "at", "with"], ttsContext: "I need to look for my keys." },
                    { sentence: "The room is full ______ people.", correct: "of", distractors: ["with", "for", "by"], ttsContext: "The room is full of people." },
                    { sentence: "The flight was delayed ______ bad weather.", correct: "due to", distractors: ["for", "with", "about"], ttsContext: "The flight was delayed due to bad weather." },
                    { sentence: "She traveled ______ plane.", correct: "by", distractors: ["with", "on", "in"], ttsContext: "She traveled by plane." },
                    { sentence: "I'm interested ______ learning French.", correct: "in", distractors: ["on", "at", "for"], ttsContext: "I'm interested in learning French." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(according to, instead of)", questions: [
                    { sentence: "______ the news, the flight has been cancelled.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "According to the news, the flight has been cancelled." },
                    { sentence: "He took a bus ______ a taxi to save money.", correct: "instead of", distractors: ["according to", "in spite of", "due to"], ttsContext: "He took a bus instead of a taxi to save money." },
                    { sentence: "Everyone agreed ______ John.", correct: "except for", distractors: ["instead of", "according to", "due to"], ttsContext: "Everyone agreed except for John." },
                    { sentence: "You must complete the task ______ yourself.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "You must complete the task by yourself." },
                    { sentence: "The committee is concerned ______ environmental issues.", correct: "about", distractors: ["for", "with", "of"], ttsContext: "The committee is concerned about environmental issues." },
                    { sentence: "He apologized ______ being late.", correct: "for", distractors: ["about", "with", "by"], ttsContext: "He apologized for being late." },
                    { sentence: "I'm going to the party ______ my best friend.", correct: "with", distractors: ["by", "for", "of"], ttsContext: "I'm going to the party with my best friend." },
                    { sentence: "The report contains information ______ the recent changes.", correct: "about", distractors: ["for", "with", "by"], ttsContext: "The report contains information about the recent changes." },
                    { sentence: "She decided to study medicine ______ becoming a lawyer.", correct: "instead of", distractors: ["according to", "due to", "in spite of"], ttsContext: "She decided to study medicine instead of becoming a lawyer." },
                    { sentence: "The meeting will proceed ______ the board's decision.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "The meeting will proceed according to the board's decision." },
                ]},
                { sub: 3, name: "Advanced", detail: "(despite, regarding)", questions: [
                    { sentence: "______ the heavy rain, they still went hiking.", correct: "in spite of", distractors: ["despite", "owing to", "regarding"], ttsContext: "In spite of the heavy rain, they still went hiking." },
                    { sentence: "______ his illness, he managed to attend the meeting.", correct: "despite", distractors: ["in spite of", "due to", "regarding"], ttsContext: "Despite his illness, he managed to attend the meeting." },
                    { sentence: "The failure was entirely ______ a lack of preparation.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The failure was entirely owing to a lack of preparation." },
                    { sentence: "We need more data ______ the sales figures.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "We need more data regarding the sales figures." },
                    { sentence: "The flight was delayed ______ mechanical problems.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The flight was delayed due to mechanical problems." },
                    { sentence: "The team won the game ______ a major setback.", correct: "despite", distractors: ["in spite of", "owing to", "according to"], ttsContext: "The team won the game despite a major setback." },
                    { sentence: "I lost my job, ______ which I had to move.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "I lost my job, owing to which I had to move." },
                    { sentence: "I have some questions ______ your last email.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "I have some questions regarding your last email." },
                    { sentence: "______ all the warnings, he continued to gamble.", correct: "in spite of", distractors: ["despite", "due to", "according to"], ttsContext: "In spite of all the warnings, he continued to gamble." },
                    { sentence: "The project was a success ______ the team's effort.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The project was a success due to the team's effort." },
                ]},
            ]},
        ];

        const QUESTIONS_PER_LEVEL = 10;
        
        // --- Elements ---
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelGridEl = document.getElementById('level-grid');
        const levelTitleEl = document.getElementById('level-title');
        const qCountEl = document.getElementById('q-count');
        const scoreEl = document.getElementById('score');
        const questionSentenceEl = document.getElementById('question-sentence');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const optionsArea = document.getElementById('options-area');
        const nextBtn = document.getElementById('next-btn');
        const headerTitleEl = document.querySelector('header h1'); 
        
        const correctAudio = document.getElementById('correct-audio');
        const incorrectAudio = document.getElementById('incorrect-audio');

        // --- State ---
        let currentLevelData, currentSubLevel, currentQuizIndex, score, isAnswered;
        let currentQuestion = {};
        let currentLevelQuestions = []; 
        let isAutoModeActive = false; 

        // --- TTS ---
        const synth = window.speechSynthesis;
        let ttsUtterance = new SpeechSynthesisUtterance();
        ttsUtterance.lang = 'en-US'; 
        ttsUtterance.rate = 0.8; 

        function initVoice() {
            const voices = synth.getVoices();
            if (voices.length > 0) {
                const maleVoice = voices.find(v => v.lang === 'en-US' && (v.name.includes('Male') || v.name.includes('Google US English')));
                if (maleVoice) ttsUtterance.voice = maleVoice;
            }
        }
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = initVoice;
        initVoice();

        function speakAnswer(text, onEndCallback) {
            if (synth.speaking) synth.cancel();
            ttsUtterance.text = text;
            ttsUtterance.onend = onEndCallback;
            synth.speak(ttsUtterance);
        }

        function playSound(isCorrect) {
            const audio = isCorrect ? correctAudio : incorrectAudio;
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed:", e));
        }

        // --- Secret Mode ---
        function toggleAutoMode() {
            isAutoModeActive = !isAutoModeActive;
            if (isAutoModeActive) {
                headerTitleEl.classList.add('auto-active');
                if (gameScreen.classList.contains('active') && !isAnswered) autoAnswer(2000);
            } else {
                headerTitleEl.classList.remove('auto-active');
                synth.cancel();
            }
        }

        function autoAnswer(delay = 2000) {
            if (!isAutoModeActive || isAnswered) return;
            setTimeout(() => {
                if (!isAutoModeActive || isAnswered) return; 
                const correctButton = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if (correctButton) correctButton.click();
            }, delay);
        }

        // --- Navigation ---
        function showScreen(screenEl) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenEl.classList.add('active');
        }

        function createLevelButtons() {
            levelGridEl.innerHTML = '';
            LEVEL_DATA.forEach(typeData => {
                typeData.levels.forEach(level => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.dataset.type = typeData.type; // For color styling
                    
                    btn.innerHTML = `
                        <span class="level-btn-type">${typeData.title}</span>
                        <span class="level-name-main">L${typeData.type}.${level.sub} - ${level.name}</span>
                        <span class="level-sub-detail">${level.detail}</span>
                    `;
                    
                    if (level.questions.length < QUESTIONS_PER_LEVEL) {
                        btn.disabled = true;
                        btn.innerHTML += ' <small>(Dev)</small>';
                    }
                    
                    btn.onclick = () => startLevel(typeData.type, level.sub);
                    levelGridEl.appendChild(btn);
                });
            });
        }

        // --- Game Logic ---
        function startLevel(typeId, subId) {
            currentLevelData = LEVEL_DATA.find(d => d.type === typeId);
            currentSubLevel = currentLevelData.levels.find(l => l.sub === subId);
            currentLevelQuestions = [...currentSubLevel.questions].sort(() => 0.5 - Math.random());
            currentQuizIndex = 0;
            score = 0; 
            
            showScreen(gameScreen);
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuizIndex >= currentLevelQuestions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            nextBtn.disabled = true;
            nextBtn.innerHTML = '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i>';
            feedbackMessageEl.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            feedbackMessageEl.style.color = 'var(--text-grey)';
            
            updateUI();
            setupQuestion();
        }

        function updateUI() {
            levelTitleEl.textContent = `L${currentLevelData.type}.${currentSubLevel.sub}`;
            qCountEl.textContent = `${currentQuizIndex + 1}/${currentLevelQuestions.length}`;
            scoreEl.textContent = `Score: ${score}`;
        }

        function setupQuestion() {
            currentQuestion = currentLevelQuestions[currentQuizIndex];
            
            // Text formatting: Use span with solid border
            questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', '<span class="blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');

            let options = [currentQuestion.correct, ...currentQuestion.distractors];
            // Ensure 4 options
            if (options.length < 4) {
                 const fillers = ["in", "on", "at", "to", "for", "with", "by", "of"];
                 fillers.forEach(f => { if(options.length < 4 && !options.includes(f)) options.push(f); });
            }
            options = options.sort(() => 0.5 - Math.random()).slice(0, 4);

            optionsArea.innerHTML = '';
            options.forEach(prep => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = prep.toUpperCase();
                btn.dataset.preposition = prep;
                btn.dataset.isCorrect = (prep === currentQuestion.correct);
                btn.onclick = handleAnswer;
                optionsArea.appendChild(btn);
            });

            if (isAutoModeActive) autoAnswer(2000);
        }

        function handleAnswer(e) {
            if (isAnswered) return;
            isAnswered = true;
            
            const selectedBtn = e.currentTarget || document.querySelector(`.option-btn[data-is-correct="true"]`);
            const isCorrect = selectedBtn.dataset.isCorrect === 'true';
            
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            if (isCorrect) {
                score++;
                playSound(true);
                selectedBtn.classList.add('correct');
                feedbackMessageEl.innerHTML = `<i class="fa-solid fa-circle-check"></i> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! (${currentQuestion.correct.toUpperCase()})`;
                feedbackMessageEl.style.color = 'var(--correct-color)';
                
                // Replace solid line with text
                const correctHtml = `<span style="color:var(--correct-color); border-bottom:3px solid var(--correct-color);">${currentQuestion.correct.toUpperCase()}</span>`;
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', correctHtml);
            } else {
                playSound(false);
                selectedBtn.classList.add('incorrect');
                const correctBtn = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if(correctBtn) correctBtn.classList.add('correct'); 

                feedbackMessageEl.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> ‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ ${currentQuestion.correct.toUpperCase()}`;
                feedbackMessageEl.style.color = 'var(--wrong-color)';
                
                const wrongHtml = `<span style="color:var(--wrong-color); border-bottom:3px solid var(--wrong-color);">${selectedBtn.dataset.preposition.toUpperCase()}</span>`;
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', wrongHtml);
            }

            updateUI();
            
            speakAnswer(currentQuestion.ttsContext, () => {
                setTimeout(() => {
                    nextBtn.disabled = false;
                    if (isAutoModeActive) nextBtn.click();
                }, 500);
            });
        }

        function endGame() {
            if (synth.speaking) synth.cancel();
            
            createConfetti();

            levelTitleEl.textContent = `Completed!`;
            qCountEl.textContent = '';
            
            feedbackMessageEl.innerHTML = `
                <div style="font-size:3rem; margin-bottom:10px;">üèÜ</div>
                <span style="font-size:1.8rem; font-weight:800; color:var(--text-dark);">
                    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span style="color:var(--correct-color)">${score}</span> / ${currentLevelQuestions.length}
                </span>
            `;
            
            optionsArea.innerHTML = '';
            questionSentenceEl.innerHTML = '<span style="color:var(--text-grey); font-size:1.2rem">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
            questionSentenceEl.style.textAlign = 'center';
            questionSentenceEl.style.display = 'flex';
            questionSentenceEl.style.justifyContent = 'center';
            questionSentenceEl.style.alignItems = 'center';
            questionSentenceEl.style.minHeight = '100px';

            nextBtn.disabled = false;
            nextBtn.innerHTML = '<i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å';
            nextBtn.onclick = () => {
                if (isAutoModeActive) toggleAutoMode();
                showScreen(levelSelectScreen);
            };
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                conf.style.animationDuration = Math.random() * 3 + 2 + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 5000);
            }
        }

        headerTitleEl.addEventListener('dblclick', toggleAutoMode);
        
        const defaultNextAction = () => {
             if (currentQuizIndex >= currentLevelQuestions.length) {
                showScreen(levelSelectScreen);
            } else {
                currentQuizIndex++;
                nextQuestion();
            }
        };
        nextBtn.onclick = defaultNextAction;

        createLevelButtons();
    </script>
</body>
</html>
