<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Preposition Master V11</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Color Palette & Variables --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-gradient: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            
            --correct-color: #00b894;
            --wrong-color: #ff7675;
            
            --text-main: #2d3436;
            --text-light: #636e72;
            --bg-color: #f3f6fd;
            
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        /* Reset & Base Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏ß‡∏î‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏π‡πÑ‡∏°‡πà‡∏à‡∏∑‡∏î */
            background-image: radial-gradient(#dfe6e9 1px, transparent 1px);
            background-size: 20px 20px;
            
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            height: 100vh; /* ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
            background-color: #ffffff;
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Responsive: ‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
        @media (min-width: 600px) {
            .container {
                max-width: 480px;
                height: 90vh;
                max-height: 900px;
                border-radius: var(--radius-lg);
                box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            }
        }

        /* --- Header (Colorful) --- */
        header {
            background: var(--header-gradient);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.2);
            z-index: 10;
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 0;
            color: #ffffff; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏≤‡∏ß */
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        @keyframes pulse-gold {
            0%, 100% { transform: scale(1); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
            50% { transform: scale(1.05); color: #ffeaa7; text-shadow: 0 0 10px rgba(255, 234, 167, 0.8); }
        }
        .auto-active {
            animation: pulse-gold 2s infinite ease-in-out;
        }

        /* --- Screens --- */
        .screen {
            flex-grow: 1;
            display: none; 
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
        }
        .screen.active { display: flex; }

        /* --- Level Selection (Colorful Cards) --- */
        .section-title {
            margin-bottom: 15px;
        }
        .section-title h2 { margin: 0; font-size: 1.4rem; color: #2d3436; }
        .section-title p { margin: 5px 0 0; font-size: 0.9rem; color: #636e72; }

        .level-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding-bottom: 20px;
        }
        @media (min-width: 360px) { .level-grid { grid-template-columns: 1fr 1fr; } }

        .level-btn {
            background: white; 
            border: none;
            border-radius: var(--radius-md);
            padding: 1.2rem 1rem;
            text-align: left;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        .level-btn::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 6px;
            background: #ccc;
        }

        /* Specific Level Themes */
        .level-btn[data-type="1"] { background: #f0f7ff; } 
        .level-btn[data-type="1"]::before { background: #4facfe; }
        .level-btn[data-type="1"] .level-name-main { color: #0052d4; }

        .level-btn[data-type="2"] { background: #f0fff4; }
        .level-btn[data-type="2"]::before { background: #43e97b; }
        .level-btn[data-type="2"] .level-name-main { color: #0ba360; }

        .level-btn[data-type="3"] { background: #fff8f0; }
        .level-btn[data-type="3"]::before { background: #fa709a; }
        .level-btn[data-type="3"] .level-name-main { color: #e65100; }

        .level-btn[data-type="4"] { background: #fbf5ff; }
        .level-btn[data-type="4"]::before { background: #a18cd1; }
        .level-btn[data-type="4"] .level-name-main { color: #6a1b9a; }

        .level-btn:active:not(:disabled) { transform: scale(0.98); }
        .level-btn:disabled { opacity: 0.6; filter: grayscale(1); }

        .level-btn-type { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px; }
        .level-name-main { font-size: 1.1rem; font-weight: 800; margin-bottom: 3px; }
        .level-sub-detail { font-size: 0.85rem; color: #636e72; }

        /* --- Game Play Area --- */
        .top-content { flex-grow: 1; display: flex; flex-direction: column; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            padding: 8px 16px;
            border-radius: 50px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-weight: 700;
            font-size: 0.9rem;
            color: #636e72;
            border: 1px solid #eee;
        }
        .score-pill { 
            background: #e0f2f1; 
            color: #009688; 
            padding: 2px 10px; 
            border-radius: 10px; 
        }

        #question-sentence {
            font-size: 1.5rem; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            font-weight: 700;
            line-height: 1.6;
            text-align: left;
            padding: 25px;
            background: #ffffff;
            border-radius: var(--radius-lg);
            /* ‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô */
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            border-left: 5px solid var(--primary-color, #6C63FF);
            margin-bottom: 20px;
            color: #2d3436;
        }

        /* ‡∏Ç‡∏µ‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
        .blank {
            color: #6c5ce7;
            font-weight: 800;
            padding: 0 4px;
            border-bottom: 3px solid #6c5ce7;
            display: inline;
            line-height: inherit;
        }

        #feedback-message {
            min-height: 24px;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #b2bec3;
        }

        #options-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .option-btn {
            background-color: #ffffff;
            color: #2d3436;
            border: 2px solid #f1f2f6; /* ‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á‡πÜ */
            border-radius: var(--radius-md);
            padding: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #dfe6e9; /* ‡πÄ‡∏á‡∏≤‡πÅ‡∏ö‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏π‡∏ô */
            transition: all 0.1s;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
        }

        /* Hover only on Desktop */
        @media (hover: hover) {
            .option-btn:hover:not(:disabled) {
                border-color: #a29bfe;
                color: #6c5ce7;
                transform: translateY(-2px);
            }
        }

        /* Active / Click State */
        .option-btn:active:not(:disabled), .option-btn.simulated-active {
            transform: translateY(4px);
            box-shadow: none;
            border-color: #a29bfe;
            background-color: #f8f9fa;
        }

        /* Correct / Incorrect */
        .option-btn.correct {
            background-color: var(--correct-color) !important;
            color: white !important;
            border-color: var(--correct-color) !important;
            box-shadow: 0 4px 0 #008f72 !important;
        }
        
        .option-btn.incorrect {
            background-color: var(--wrong-color) !important;
            color: white !important;
            border-color: var(--wrong-color) !important;
            box-shadow: 0 4px 0 #d63031 !important;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Footer & Next Button */
        #game-footer { margin-top: auto; padding-top: 1rem; }

        #next-btn {
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            width: 100%;
            padding: 1.2rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(37, 117, 252, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        
        #next-btn:active, #next-btn.simulated-click { 
            transform: scale(0.97); 
            box-shadow: 0 4px 10px rgba(37, 117, 252, 0.2);
        }
        
        /* Auto Mode Button State */
        #next-btn:disabled { 
            opacity: 1; /* Keep it visible/colorful even if disabled */
            cursor: default;
        }
        /* Visual disable for manual mode only */
        .manual-disabled {
            background: #dfe6e9 !important;
            color: #b2bec3 !important;
            box-shadow: none !important;
        }

        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            z-index: 100;
            animation: fall linear forwards;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="app-title">Preposition Master</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <div class="section-title">
                <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üéØ</h2>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô (120 ‡∏Ç‡πâ‡∏≠)</p>
            </div>
            <div class="level-grid" id="level-grid">
                </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="top-content">
                <div class="status-bar">
                    <span id="level-title">Level 1</span>
                    <span id="q-count">1/10</span>
                    <span class="score-pill" id="score">0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                </div>

                <div id="prompt-area">
                    <div id="question-sentence"></div>
                    <div id="feedback-message">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                </div>

                <div id="options-area">
                    </div>
            </div>

            <div id="game-footer">
                <button id="next-btn">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <audio id="correct-audio" src="sounds/correct.mp3"></audio>
    <audio id="incorrect-audio" src="sounds/incorrect.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>

    <script>
        /* ------------------- Preposition Master V11 Logic ------------------- */
        
        const LEVEL_DATA = [
            // TYPE 1: PLACE
            { type: 1, title: "1. PLACE (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)", levels: [
                { sub: 1, name: "Basic", detail: "(in, on, at)", questions: [ 
                    { sentence: "The book is ______ the table.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "The book is on the table." },
                    { sentence: "She lives ______ Bangkok.", correct: "in", distractors: ["on", "at", "over"], ttsContext: "She lives in Bangkok." },
                    { sentence: "I saw him standing ______ the corner.", correct: "at", distractors: ["in", "on", "from"], ttsContext: "I saw him standing at the corner." },
                    { sentence: "The picture is hanging ______ the wall.", correct: "on", distractors: ["in", "at", "with"], ttsContext: "The picture is hanging on the wall." },
                    { sentence: "The toys are ______ the box.", correct: "in", distractors: ["on", "at", "under"], ttsContext: "The toys are in the box." },
                    { sentence: "The cat is hiding ______ the sofa.", correct: "under", distractors: ["over", "at", "by"], ttsContext: "The cat is hiding under the sofa." },
                    { sentence: "I parked my car ______ the building.", correct: "behind", distractors: ["in", "on", "into"], ttsContext: "I parked my car behind the building." },
                    { sentence: "The plane flew ______ the mountains.", correct: "over", distractors: ["under", "at", "on"], ttsContext: "The plane flew over the mountains." },
                    { sentence: "Please meet me ______ the entrance.", correct: "at", distractors: ["in", "on", "with"], ttsContext: "Please meet me at the entrance." },
                    { sentence: "There is a beautiful garden ______ the house.", correct: "behind", distractors: ["on", "at", "with"], ttsContext: "There is a beautiful garden behind the house." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(between, next to)", questions: [ 
                    { sentence: "The store is located ______ the bank and the post office.", correct: "between", distractors: ["among", "near", "with"], ttsContext: "The store is located between the bank and the post office." },
                    { sentence: "The three friends sat ______ the campfire.", correct: "around", distractors: ["between", "next to", "on"], ttsContext: "The three friends sat around the campfire." },
                    { sentence: "My house is ______ the school.", correct: "near", distractors: ["on", "at", "above"], ttsContext: "My house is near the school." },
                    { sentence: "The pharmacy is ______ the coffee shop.", correct: "next to", distractors: ["in", "at", "over"], ttsContext: "The pharmacy is next to the coffee shop." },
                    { sentence: "He placed his hand ______ my shoulder.", correct: "on", distractors: ["in", "at", "under"], ttsContext: "He placed his hand on my shoulder." },
                    { sentence: "The children played happily ______ the trees.", correct: "among", distractors: ["between", "near", "on"], ttsContext: "The children played happily among the trees." },
                    { sentence: "The whiteboard is ______ the projector.", correct: "opposite", distractors: ["beside", "at", "over"], ttsContext: "The whiteboard is opposite the projector." },
                    { sentence: "I left my shoes ______ the door.", correct: "by", distractors: ["in", "on", "above"], ttsContext: "I left my shoes by the door." },
                    { sentence: "The clouds floated ______ the city.", correct: "above", distractors: ["under", "at", "on"], ttsContext: "The clouds floated above the city." },
                    { sentence: "The ship sailed ______ the coast.", correct: "along", distractors: ["in", "at", "under"], ttsContext: "The ship sailed along the coast." },
                ]},
                { sub: 3, name: "Advanced", detail: "(in front of, over)", questions: [
                    { sentence: "They pitched their tent ______ the lake.", correct: "beside", distractors: ["in front of", "over", "at"], ttsContext: "They pitched their tent beside the lake." },
                    { sentence: "The car is parked ______ the building entrance.", correct: "in front of", distractors: ["behind", "on", "over"], ttsContext: "The car is parked in front of the building entrance." },
                    { sentence: "The temperature is ten degrees ______ zero.", correct: "below", distractors: ["above", "on", "at"], ttsContext: "The temperature is ten degrees below zero." },
                    { sentence: "The plane flew ______ the city.", correct: "over", distractors: ["through", "in", "at"], ttsContext: "The plane flew over the city." },
                    { sentence: "The restaurant is just ______ the corner.", correct: "around", distractors: ["in", "on", "at"], ttsContext: "The restaurant is just around the corner." },
                    { sentence: "I often find him hiding ______ the curtains.", correct: "behind", distractors: ["in front of", "on", "at"], ttsContext: "I often find him hiding behind the curtains." },
                    { sentence: "The sign was placed ______ the top of the hill.", correct: "at", distractors: ["on", "in", "over"], ttsContext: "The sign was placed at the top of the hill." },
                    { sentence: "The baby is lying ______ his mother.", correct: "beside", distractors: ["among", "over", "at"], ttsContext: "The baby is lying beside his mother." },
                    { sentence: "There's a fence running ______ the garden.", correct: "around", distractors: ["in", "at", "on"], ttsContext: "There's a fence running around the garden." },
                    { sentence: "We must look ______ the surface.", correct: "beneath", distractors: ["above", "on", "at"], ttsContext: "We must look beneath the surface." },
                ]},
            ]},
            // TYPE 2: TIME
            { type: 2, title: "2. TIME (‡πÄ‡∏ß‡∏•‡∏≤)", levels: [
                { sub: 1, name: "Basic", detail: "(at, on, in)", questions: [
                    { sentence: "The sun rises ______ the morning.", correct: "in", distractors: ["on", "at", "to"], ttsContext: "The sun rises in the morning." },
                    { sentence: "I always wake up ______ six o'clock.", correct: "at", distractors: ["in", "on", "for"], ttsContext: "I always wake up at six o'clock." },
                    { sentence: "We have a holiday ______ December.", correct: "in", distractors: ["on", "at", "with"], ttsContext: "We have a holiday in December." },
                    { sentence: "She was born ______ the 14th of June.", correct: "on", distractors: ["in", "at", "to"], ttsContext: "She was born on the 14th of June." },
                    { sentence: "I will call you ______ the weekend.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "I will call you on the weekend." },
                    { sentence: "Dinner will be ready ______ half an hour.", correct: "in", distractors: ["on", "at", "before"], ttsContext: "Dinner will be ready in half an hour." },
                    { sentence: "The party is ______ Friday night.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The party is on Friday night." },
                    { sentence: "I feel tired ______ midnight.", correct: "at", distractors: ["in", "on", "until"], ttsContext: "I feel tired at midnight." },
                    { sentence: "He worked there ______ 2020.", correct: "in", distractors: ["on", "at", "since"], ttsContext: "He worked there in 2020." },
                    { sentence: "She always studies ______ night.", correct: "at", distractors: ["in", "on", "during"], ttsContext: "She always studies at night." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(since, for, during)", questions: [
                    { sentence: "We have been waiting ______ two hours.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We have been waiting for two hours." },
                    { sentence: "I haven't seen him ______ last summer.", correct: "since", distractors: ["for", "during", "at"], ttsContext: "I haven't seen him since last summer." },
                    { sentence: "She fell asleep ______ the movie.", correct: "during", distractors: ["for", "since", "on"], ttsContext: "She fell asleep during the movie." },
                    { sentence: "They traveled abroad ______ the summer break.", correct: "during", distractors: ["for", "since", "at"], ttsContext: "They traveled abroad during the summer break." },
                    { sentence: "He will finish the report ______ next week.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "He will finish the report by next week." },
                    { sentence: "I worked continuously ______ 5 AM.", correct: "until", distractors: ["by", "for", "in"], ttsContext: "I worked continuously until 5 A.M." },
                    { sentence: "It has been raining heavily ______ Monday morning.", correct: "since", distractors: ["for", "during", "on"], ttsContext: "It has been raining heavily since Monday morning." },
                    { sentence: "We stopped talking ______ a moment.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "We stopped talking for a moment." },
                    { sentence: "I finished my homework just ______ the deadline.", correct: "before", distractors: ["after", "during", "at"], ttsContext: "I finished my homework just before the deadline." },
                    { sentence: "We waited for the bus ______ 10 minutes.", correct: "for", distractors: ["since", "during", "in"], ttsContext: "We waited for the bus for 10 minutes." },
                ]},
                { sub: 3, name: "Advanced", detail: "(by, until, in time)", questions: [
                    { sentence: "You must submit the application ______ Friday.", correct: "by", distractors: ["until", "for", "since"], ttsContext: "You must submit the application by Friday." },
                    { sentence: "The meeting is scheduled to start ______ 2:00 PM.", correct: "at", distractors: ["in", "on", "by"], ttsContext: "The meeting is scheduled to start at 2 P.M." },
                    { sentence: "We arrived ______ time for the flight.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We arrived in time for the flight." },
                    { sentence: "The train left exactly ______ time.", correct: "on", distractors: ["in", "at", "by"], ttsContext: "The train left exactly on time." },
                    { sentence: "The contract is valid ______ the end of the year.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "The contract is valid until the end of the year." },
                    { sentence: "He promised to be here ______ five o'clock.", correct: "by", distractors: ["until", "since", "in"], ttsContext: "He promised to be here by five o'clock." },
                    { sentence: "The shop is closed ______ Sundays.", correct: "on", distractors: ["in", "at", "for"], ttsContext: "The shop is closed on Sundays." },
                    { sentence: "I haven't smoked a cigarette ______ five years.", correct: "for", distractors: ["since", "during", "at"], ttsContext: "I haven't smoked a cigarette for five years." },
                    { sentence: "We managed to get to the airport just ______ time.", correct: "in", distractors: ["on", "at", "by"], ttsContext: "We managed to get to the airport just in time." },
                    { sentence: "I'll wait for you ______ the movie starts.", correct: "until", distractors: ["by", "for", "since"], ttsContext: "I'll wait for you until the movie starts." },
                ]},
            ]},
            // TYPE 3: DIRECTION
            { type: 3, title: "3. DIRECTION (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á)", levels: [
                { sub: 1, name: "Basic", detail: "(to, into, through)", questions: [
                    { sentence: "She walked ______ the park.", correct: "to", distractors: ["into", "through", "on"], ttsContext: "She walked to the park." },
                    { sentence: "He jumped ______ the pool.", correct: "into", distractors: ["to", "at", "on"], ttsContext: "He jumped into the pool." },
                    { sentence: "We drove ______ the tunnel.", correct: "through", distractors: ["into", "on", "at"], ttsContext: "We drove through the tunnel." },
                    { sentence: "The child ran ______ his mother.", correct: "toward", distractors: ["from", "on", "in"], ttsContext: "The child ran toward his mother." },
                    { sentence: "The hiker climbed ______ the mountain.", correct: "up", distractors: ["down", "across", "on"], ttsContext: "The hiker climbed up the mountain." },
                    { sentence: "I took the book ______ the shelf.", correct: "from", distractors: ["to", "out of", "on"], ttsContext: "I took the book from the shelf." },
                    { sentence: "The tourists walked ______ the street.", correct: "along", distractors: ["into", "at", "on"], ttsContext: "The tourists walked along the street." },
                    { sentence: "She stepped ______ the car.", correct: "out of", distractors: ["into", "on", "to"], ttsContext: "She stepped out of the car." },
                    { sentence: "The dog chased the cat ______ the house.", correct: "around", distractors: ["across", "through", "to"], ttsContext: "The dog chased the cat around the house." },
                    { sentence: "He moved ______ London when he was 10.", correct: "to", distractors: ["at", "in", "from"], ttsContext: "He moved to London when he was 10." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(across, along, past)", questions: [
                    { sentence: "The ferry takes people ______ the river.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "The ferry takes people across the river." },
                    { sentence: "We strolled quietly ______ the beach.", correct: "along", distractors: ["across", "past", "through"], ttsContext: "We strolled quietly along the beach." },
                    { sentence: "I saw her driving ______ my house yesterday.", correct: "past", distractors: ["across", "along", "into"], ttsContext: "I saw her driving past my house yesterday." },
                    { sentence: "He threw the ball ______ the fence.", correct: "over", distractors: ["under", "through", "along"], ttsContext: "He threw the ball over the fence." },
                    { sentence: "The train sped ______ the fields.", correct: "through", distractors: ["across", "along", "to"], ttsContext: "The train sped through the fields." },
                    { sentence: "The children ran ______ the playground.", correct: "around", distractors: ["across", "past", "to"], ttsContext: "The children ran around the playground." },
                    { sentence: "We have to walk ______ the bridge to get there.", correct: "across", distractors: ["along", "past", "into"], ttsContext: "We have to walk across the bridge to get there." },
                    { sentence: "I followed the path ______ the hillside.", correct: "along", distractors: ["across", "past", "over"], ttsContext: "I followed the path along the hillside." },
                    { sentence: "The car drove straight ______ the intersection.", correct: "through", distractors: ["across", "past", "to"], ttsContext: "The car drove straight through the intersection." },
                    { sentence: "The runner went straight ______ the finish line.", correct: "for", distractors: ["to", "at", "on"], ttsContext: "The runner went straight for the finish line." },
                ]},
                { sub: 3, name: "Advanced", detail: "(up, down, toward)", questions: [
                    { sentence: "The price of oil went sharply ______ last month.", correct: "up", distractors: ["down", "toward", "away from"], ttsContext: "The price of oil went sharply up last month." },
                    { sentence: "Please move ______ the fire exit.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "Please move away from the fire exit." },
                    { sentence: "We walked slowly ______ the sound of the music.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "We walked slowly toward the sound of the music." },
                    { sentence: "Tears rolled ______ her face.", correct: "down", distractors: ["up", "toward", "from"], ttsContext: "Tears rolled down her face." },
                    { sentence: "The dog swam ______ the boat.", correct: "toward", distractors: ["away from", "up", "down"], ttsContext: "The dog swam toward the boat." },
                    { sentence: "He looked ______ the ceiling with a confused expression.", correct: "up at", distractors: ["down at", "toward", "away from"], ttsContext: "He looked up at the ceiling with a confused expression." },
                    { sentence: "They are moving ______ the hustle and bustle of the city.", correct: "away from", distractors: ["toward", "up", "down"], ttsContext: "They are moving away from the hustle and bustle of the city." },
                    { sentence: "The stream flows gently ______ the valley.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "The stream flows gently down the valley." },
                    { sentence: "The climber struggled ______ the steep slope.", correct: "up", distractors: ["down", "toward", "from"], ttsContext: "The climber struggled up the steep slope." },
                    { sentence: "He glanced ______ the list to check the names.", correct: "down", distractors: ["up", "toward", "away from"], ttsContext: "He glanced down the list to check the names." },
                ]},
            ]},
            // TYPE 4: OTHER
            { type: 4, title: "4. OTHER (‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)", levels: [
                { sub: 1, name: "Basic", detail: "(of, with, for)", questions: [
                    { sentence: "This is a picture ______ my family.", correct: "of", distractors: ["for", "with", "at"], ttsContext: "This is a picture of my family." },
                    { sentence: "I wrote the letter ______ a pen.", correct: "with", distractors: ["by", "for", "to"], ttsContext: "I wrote the letter with a pen." },
                    { sentence: "The cake was made ______ my mother.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "The cake was made by my mother." },
                    { sentence: "She is famous ______ her kindness.", correct: "for", distractors: ["of", "with", "at"], ttsContext: "She is famous for her kindness." },
                    { sentence: "We talked ______ the new project.", correct: "about", distractors: ["to", "for", "with"], ttsContext: "We talked about the new project." },
                    { sentence: "I need to look ______ my keys.", correct: "for", distractors: ["up", "at", "with"], ttsContext: "I need to look for my keys." },
                    { sentence: "The room is full ______ people.", correct: "of", distractors: ["with", "for", "by"], ttsContext: "The room is full of people." },
                    { sentence: "The flight was delayed ______ bad weather.", correct: "due to", distractors: ["for", "with", "about"], ttsContext: "The flight was delayed due to bad weather." },
                    { sentence: "She traveled ______ plane.", correct: "by", distractors: ["with", "on", "in"], ttsContext: "She traveled by plane." },
                    { sentence: "I'm interested ______ learning French.", correct: "in", distractors: ["on", "at", "for"], ttsContext: "I'm interested in learning French." },
                ]},
                { sub: 2, name: "Intermediate", detail: "(according to, instead of)", questions: [
                    { sentence: "______ the news, the flight has been cancelled.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "According to the news, the flight has been cancelled." },
                    { sentence: "He took a bus ______ a taxi to save money.", correct: "instead of", distractors: ["according to", "in spite of", "due to"], ttsContext: "He took a bus instead of a taxi to save money." },
                    { sentence: "Everyone agreed ______ John.", correct: "except for", distractors: ["instead of", "according to", "due to"], ttsContext: "Everyone agreed except for John." },
                    { sentence: "You must complete the task ______ yourself.", correct: "by", distractors: ["with", "for", "of"], ttsContext: "You must complete the task by yourself." },
                    { sentence: "The committee is concerned ______ environmental issues.", correct: "about", distractors: ["for", "with", "of"], ttsContext: "The committee is concerned about environmental issues." },
                    { sentence: "He apologized ______ being late.", correct: "for", distractors: ["about", "with", "by"], ttsContext: "He apologized for being late." },
                    { sentence: "I'm going to the party ______ my best friend.", correct: "with", distractors: ["by", "for", "of"], ttsContext: "I'm going to the party with my best friend." },
                    { sentence: "The report contains information ______ the recent changes.", correct: "about", distractors: ["for", "with", "by"], ttsContext: "The report contains information about the recent changes." },
                    { sentence: "She decided to study medicine ______ becoming a lawyer.", correct: "instead of", distractors: ["according to", "due to", "in spite of"], ttsContext: "She decided to study medicine instead of becoming a lawyer." },
                    { sentence: "The meeting will proceed ______ the board's decision.", correct: "according to", distractors: ["instead of", "despite", "with"], ttsContext: "The meeting will proceed according to the board's decision." },
                ]},
                { sub: 3, name: "Advanced", detail: "(despite, regarding)", questions: [
                    { sentence: "______ the heavy rain, they still went hiking.", correct: "in spite of", distractors: ["despite", "owing to", "regarding"], ttsContext: "In spite of the heavy rain, they still went hiking." },
                    { sentence: "______ his illness, he managed to attend the meeting.", correct: "despite", distractors: ["in spite of", "due to", "regarding"], ttsContext: "Despite his illness, he managed to attend the meeting." },
                    { sentence: "The failure was entirely ______ a lack of preparation.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The failure was entirely owing to a lack of preparation." },
                    { sentence: "We need more data ______ the sales figures.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "We need more data regarding the sales figures." },
                    { sentence: "The flight was delayed ______ mechanical problems.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The flight was delayed due to mechanical problems." },
                    { sentence: "The team won the game ______ a major setback.", correct: "despite", distractors: ["in spite of", "owing to", "according to"], ttsContext: "The team won the game despite a major setback." },
                    { sentence: "I lost my job, ______ which I had to move.", correct: "owing to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "I lost my job, owing to which I had to move." },
                    { sentence: "I have some questions ______ your last email.", correct: "regarding", distractors: ["despite", "owing to", "in spite of"], ttsContext: "I have some questions regarding your last email." },
                    { sentence: "______ all the warnings, he continued to gamble.", correct: "in spite of", distractors: ["despite", "due to", "according to"], ttsContext: "In spite of all the warnings, he continued to gamble." },
                    { sentence: "The project was a success ______ the team's effort.", correct: "due to", distractors: ["despite", "in spite of", "regarding"], ttsContext: "The project was a success due to the team's effort." },
                ]},
            ]},
        ];

        const QUESTIONS_PER_LEVEL = 10;
        
        // --- Elements ---
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelGridEl = document.getElementById('level-grid');
        const levelTitleEl = document.getElementById('level-title');
        const qCountEl = document.getElementById('q-count');
        const scoreEl = document.getElementById('score');
        const questionSentenceEl = document.getElementById('question-sentence');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const optionsArea = document.getElementById('options-area');
        const nextBtn = document.getElementById('next-btn');
        const headerTitleEl = document.querySelector('header h1'); 
        
        const correctAudio = document.getElementById('correct-audio');
        const incorrectAudio = document.getElementById('incorrect-audio');

        // --- State ---
        let currentLevelData, currentSubLevel, currentQuizIndex, score, isAnswered;
        let currentQuestion = {};
        let currentLevelQuestions = []; 
        let isAutoModeActive = false; 

        // --- TTS ---
        const synth = window.speechSynthesis;
        let ttsUtterance = new SpeechSynthesisUtterance();
        ttsUtterance.lang = 'en-US'; 
        ttsUtterance.rate = 0.8; 

        function initVoice() {
            const voices = synth.getVoices();
            if (voices.length > 0) {
                const maleVoice = voices.find(v => v.lang === 'en-US' && (v.name.includes('Male') || v.name.includes('Google US English')));
                if (maleVoice) ttsUtterance.voice = maleVoice;
            }
        }
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = initVoice;
        initVoice();

        function speakAnswer(text, onEndCallback) {
            if (synth.speaking) synth.cancel();
            ttsUtterance.text = text;
            
            const handleEnd = () => {
                ttsUtterance.removeEventListener('end', handleEnd);
                if(onEndCallback) onEndCallback();
            };
            ttsUtterance.addEventListener('end', handleEnd);
            
            setTimeout(() => { if(synth.speaking) {} }, 5000);
            synth.speak(ttsUtterance);
        }

        function playSound(isCorrect) {
            const audio = isCorrect ? correctAudio : incorrectAudio;
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed:", e));
        }

        // --- Secret Mode ---
        function toggleAutoMode() {
            isAutoModeActive = !isAutoModeActive;
            if (isAutoModeActive) {
                headerTitleEl.classList.add('auto-active');
                if (gameScreen.classList.contains('active') && !isAnswered) autoAnswer(2000);
            } else {
                headerTitleEl.classList.remove('auto-active');
                synth.cancel();
            }
        }

        function autoAnswer(delay = 2000) {
            if (!isAutoModeActive || isAnswered) return;
            setTimeout(() => {
                if (!isAutoModeActive || isAnswered) return; 
                
                const correctButton = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if (correctButton) {
                    correctButton.classList.add('simulated-active');
                    setTimeout(() => {
                        correctButton.classList.remove('simulated-active');
                        correctButton.click();
                    }, 150);
                }
            }, delay);
        }

        // --- Navigation ---
        function showScreen(screenEl) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenEl.classList.add('active');
        }

        function createLevelButtons() {
            levelGridEl.innerHTML = '';
            LEVEL_DATA.forEach(typeData => {
                typeData.levels.forEach(level => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.dataset.type = typeData.type; 
                    
                    btn.innerHTML = `
                        <span class="level-btn-type">${typeData.title}</span>
                        <span class="level-name-main">L${typeData.type}.${level.sub} - ${level.name}</span>
                        <span class="level-sub-detail">${level.detail}</span>
                    `;
                    
                    if (level.questions.length < QUESTIONS_PER_LEVEL) {
                        btn.disabled = true;
                        btn.innerHTML += ' <small>(Dev)</small>';
                    }
                    
                    btn.onclick = () => startLevel(typeData.type, level.sub);
                    levelGridEl.appendChild(btn);
                });
            });
        }

        // --- Game Logic ---
        function startLevel(typeId, subId) {
            nextBtn.onclick = handleNextQuestion; 

            currentLevelData = LEVEL_DATA.find(d => d.type === typeId);
            currentSubLevel = currentLevelData.levels.find(l => l.sub === subId);
            currentLevelQuestions = [...currentSubLevel.questions].sort(() => 0.5 - Math.random());
            currentQuizIndex = 0;
            score = 0; 
            
            showScreen(gameScreen);
            nextQuestion();
        }

        function handleNextQuestion() {
            if (currentQuizIndex >= currentLevelQuestions.length) {
                showScreen(levelSelectScreen);
            } else {
                currentQuizIndex++;
                nextQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuizIndex >= currentLevelQuestions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            
            // Clean styles (prevent flexbox bugs from previous end screen)
            questionSentenceEl.removeAttribute('style');
            if(document.activeElement) document.activeElement.blur();

            nextBtn.disabled = true; 
            // Manual mode gets gray, Auto mode stays colorful
            if(!isAutoModeActive) nextBtn.classList.add('manual-disabled');
            else nextBtn.classList.remove('manual-disabled');

            nextBtn.innerHTML = '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i>';
            feedbackMessageEl.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            feedbackMessageEl.style.color = '#b2bec3';
            
            updateUI();
            setupQuestion();
        }

        function updateUI() {
            levelTitleEl.textContent = `L${currentLevelData.type}.${currentSubLevel.sub}`;
            qCountEl.textContent = `${currentQuizIndex + 1}/${currentLevelQuestions.length}`;
            scoreEl.textContent = `${score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
        }

        function setupQuestion() {
            currentQuestion = currentLevelQuestions[currentQuizIndex];
            
            questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', '<span class="blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');

            let options = [currentQuestion.correct, ...currentQuestion.distractors];
            if (options.length < 4) {
                 const fillers = ["in", "on", "at", "to", "for", "with", "by", "of"];
                 fillers.forEach(f => { if(options.length < 4 && !options.includes(f)) options.push(f); });
            }
            options = options.sort(() => 0.5 - Math.random()).slice(0, 4);

            optionsArea.innerHTML = '';
            options.forEach(prep => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = prep.toUpperCase();
                btn.dataset.preposition = prep;
                btn.dataset.isCorrect = (prep === currentQuestion.correct);
                btn.onclick = handleAnswer;
                optionsArea.appendChild(btn);
            });

            if (isAutoModeActive) autoAnswer(2000);
        }

        function handleAnswer(e) {
            if (isAnswered) return;
            isAnswered = true;
            
            const selectedBtn = e.currentTarget || document.querySelector(`.option-btn[data-is-correct="true"]`);
            const isCorrect = selectedBtn.dataset.isCorrect === 'true';
            
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            if (isCorrect) {
                score++;
                playSound(true);
                selectedBtn.classList.add('correct');
                feedbackMessageEl.innerHTML = `<i class="fa-solid fa-circle-check"></i> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! (${currentQuestion.correct.toUpperCase()})`;
                feedbackMessageEl.style.color = 'var(--correct-color)';
                
                const correctHtml = `<span style="color:var(--correct-color); border-bottom:3px solid var(--correct-color);">${currentQuestion.correct.toUpperCase()}</span>`;
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', correctHtml);
            } else {
                playSound(false);
                selectedBtn.classList.add('incorrect');
                const correctBtn = document.querySelector(`.option-btn[data-is-correct="true"]`);
                if(correctBtn) correctBtn.classList.add('correct'); 

                feedbackMessageEl.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> ‡∏ú‡∏¥‡∏î! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ ${currentQuestion.correct.toUpperCase()}`;
                feedbackMessageEl.style.color = 'var(--wrong-color)';
                
                const wrongHtml = `<span style="color:var(--wrong-color); border-bottom:3px solid var(--wrong-color);">${selectedBtn.dataset.preposition.toUpperCase()}</span>`;
                questionSentenceEl.innerHTML = currentQuestion.sentence.replace('______', wrongHtml);
            }

            updateUI();
            
            speakAnswer(currentQuestion.ttsContext, () => {
                setTimeout(() => {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('manual-disabled');
                    
                    if (isAutoModeActive) {
                        nextBtn.classList.add('simulated-click');
                        setTimeout(() => {
                            nextBtn.classList.remove('simulated-click');
                            if(nextBtn.onclick) nextBtn.onclick();
                        }, 150);
                    }
                }, 500);
            });
        }

        function endGame() {
            if (synth.speaking) synth.cancel();
            
            createConfetti();

            levelTitleEl.textContent = `Completed!`;
            qCountEl.textContent = '';
            
            feedbackMessageEl.innerHTML = `
                <div style="font-size:3rem; margin-bottom:10px;">üèÜ</div>
                <span style="font-size:1.8rem; font-weight:800; color:var(--text-main);">
                    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span style="color:var(--correct-color)">${score}</span> / ${currentLevelQuestions.length}
                </span>
            `;
            
            optionsArea.innerHTML = '';
            questionSentenceEl.innerHTML = '<span style="color:#b2bec3; font-size:1.2rem">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
            questionSentenceEl.style.textAlign = 'center';
            questionSentenceEl.style.display = 'flex';
            questionSentenceEl.style.justifyContent = 'center';
            questionSentenceEl.style.alignItems = 'center';
            questionSentenceEl.style.minHeight = '100px';

            nextBtn.disabled = false;
            nextBtn.classList.remove('manual-disabled');
            nextBtn.innerHTML = '<i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å';
            
            nextBtn.onclick = () => {
                if (isAutoModeActive) toggleAutoMode();
                showScreen(levelSelectScreen);
            };
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                conf.style.animationDuration = Math.random() * 3 + 2 + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 5000);
            }
        }

        headerTitleEl.addEventListener('dblclick', toggleAutoMode);
        nextBtn.onclick = handleNextQuestion;
        createLevelButtons();
    </script>
</body>
</html>
